<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GoFast — Détection des convois de véhicules</title>

  <!-- Favicon (DSFR) -->
  <link rel="icon" type="image/png"
        href="https://www.interieur.gouv.fr/themes/custom/dsfr/src/images/logo/favicon.png">

  <!-- DSFR -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/dsfr/dsfr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/dsfr/utility/utilities.min.css">
</head>

<body>
  <!-- HEADER DSFR -->
  <header role="banner" class="fr-header">
    <div class="fr-header__body">
      <div class="fr-container">
        <div class="fr-header__body-row">
          <div class="fr-header__brand fr-enlarge-link">
            <div class="fr-header__brand-top">
              <div class="fr-header__logo">
                <p class="fr-logo">
                  République<br />Française
                </p>
              </div>
              <div class="fr-header__navbar">
                <button class="fr-btn--menu fr-btn" data-fr-opened="false" aria-controls="modal-menu" aria-haspopup="menu" title="Menu">
                  Menu
                </button>
              </div>
            </div>

            <div class="fr-header__service">
              <a href="#" title="Accueil">
                <p class="fr-header__service-title">GoFast</p>
              </a>
              <p class="fr-header__service-tagline">Détection des convois de véhicules</p>
            </div>
          </div>

          <div class="fr-header__tools">
            <div class="fr-header__tools-links">
              <ul class="fr-btns-group fr-btns-group--sm">
                <li>
                  <button id="btnDemo" class="fr-btn fr-btn--secondary">Charger un jeu de démo</button>
                </li>
                <li>
                  <button id="btnReset" class="fr-btn fr-btn--secondary">Réinitialiser</button>
                </li>
              </ul>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- MENU (optionnel) -->
    <div class="fr-header__menu fr-modal" id="modal-menu" aria-labelledby="modal-menu-title">
      <div class="fr-container">
        <button class="fr-btn--close fr-btn" aria-controls="modal-menu" title="Fermer">Fermer</button>
        <div class="fr-header__menu-links"></div>
        <nav class="fr-nav" role="navigation" aria-label="Menu principal">
          <ul class="fr-nav__list">
            <li class="fr-nav__item"><a class="fr-nav__link" href="#import">Import</a></li>
            <li class="fr-nav__item"><a class="fr-nav__link" href="#parametres">Paramètres</a></li>
            <li class="fr-nav__item"><a class="fr-nav__link" href="#resultats">Résultats</a></li>
          </ul>
        </nav>
      </div>
    </div>
  </header>

  <main class="fr-container fr-my-4w">
    <!-- BANNIÈRE CONFIDENTIALITÉ -->
    <div class="fr-alert fr-alert--info fr-mb-3w" role="alert">
      <h3 class="fr-alert__title">Traitement local</h3>
      <p>
        Les fichiers sont analysés <strong>uniquement dans ton navigateur</strong>.
        Aucune donnée n’est envoyée sur Internet.
      </p>
    </div>

    <!-- GRID -->
    <div class="fr-grid-row fr-grid-row--gutters">

      <!-- IMPORT -->
      <div class="fr-col-12 fr-col-lg-6" id="import">
        <div class="fr-card fr-enlarge-link fr-card--no-arrow">
          <div class="fr-card__body">
            <div class="fr-card__content">
              <h3 class="fr-card__title">Import des fichiers</h3>
              <p class="fr-card__desc">
                Importe un ou plusieurs fichiers CSV (LAPI, péage, exports, etc.).
              </p>

              <div class="fr-upload-group fr-mt-2w">
                <label class="fr-label" for="fileInput">
                  Sélectionner des fichiers CSV
                  <span class="fr-hint-text">Format CSV recommandé (UTF-8). Tu peux en sélectionner plusieurs.</span>
                </label>
                <input class="fr-upload" type="file" id="fileInput" accept=".csv,text/csv" multiple />
              </div>

              <div id="dropzone" class="fr-mt-2w fr-p-2w"
                   style="border: 2px dashed var(--border-default-grey); border-radius: 8px;">
                <strong>Glisse-dépose</strong> tes fichiers ici
                <div class="fr-hint-text fr-mt-1v">Astuce : tu peux aussi déposer des fichiers directement depuis l’explorateur.</div>
              </div>

              <div class="fr-mt-2w">
                <button id="btnParse" class="fr-btn" disabled>Analyser les fichiers</button>
              </div>

              <div class="fr-mt-2w">
                <p class="fr-text--sm fr-mb-1v"><strong>Fichiers chargés :</strong></p>
                <ul id="fileList" class="fr-m-0 fr-pl-2w"></ul>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- PARAMÈTRES -->
      <div class="fr-col-12 fr-col-lg-6" id="parametres">
        <div class="fr-card fr-enlarge-link fr-card--no-arrow">
          <div class="fr-card__body">
            <div class="fr-card__content">
              <h3 class="fr-card__title">Paramètres</h3>
              <p class="fr-card__desc">Ajuste les seuils de détection.</p>

              <div class="fr-input-group">
                <label class="fr-label" for="thresholdSeconds">
                  Seuil temporel (secondes)
                  <span class="fr-hint-text">Intervalle max entre véhicules pour considérer un co-passage.</span>
                </label>
                <input class="fr-input" type="number" id="thresholdSeconds" min="5" max="900" step="5" value="90" />
              </div>

              <div class="fr-input-group">
                <label class="fr-label" for="minVehicles">
                  Nombre minimal de véhicules
                  <span class="fr-hint-text">2 = duo suspect, 3 = ouvreuse/porteuse/suiveuse.</span>
                </label>
                <input class="fr-input" type="number" id="minVehicles" min="2" max="10" step="1" value="3" />
              </div>

              <div class="fr-input-group">
                <label class="fr-label" for="minSites">
                  Nombre minimal de sites (lieux)
                  <span class="fr-hint-text">Répétition sur plusieurs lieux = suspicion renforcée.</span>
                </label>
                <input class="fr-input" type="number" id="minSites" min="1" max="50" step="1" value="2" />
              </div>

              <div class="fr-toggle fr-mt-2w">
                <input type="checkbox" class="fr-toggle__input" id="toggleStrictOrder" checked>
                <label class="fr-toggle__label" for="toggleStrictOrder">
                  Favoriser l’ordre stable (ouvreuse → porteuse → suiveuse)
                </label>
              </div>

              <div class="fr-mt-2w fr-text--sm fr-hint-text">
                Note : GoFast met en évidence des corrélations. Il ne “décide” pas à ta place.
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- RÉSULTATS -->
      <div class="fr-col-12" id="resultats">
        <div class="fr-card fr-enlarge-link fr-card--no-arrow">
          <div class="fr-card__body">
            <div class="fr-card__content">
              <h3 class="fr-card__title">Résultats</h3>
              <p class="fr-card__desc">
                Groupes détectés, triés par score décroissant.
              </p>

              <div class="fr-mb-2w">
                <span class="fr-badge fr-badge--info" id="statusBadge">En attente d’import</span>
                <span class="fr-ml-2w fr-text--sm fr-hint-text" id="statsText"></span>
              </div>

              <div class="fr-table fr-table--bordered fr-table--layout-fixed">
                <table>
                  <thead>
                    <tr>
                      <th scope="col">Score</th>
                      <th scope="col">Véhicules</th>
                      <th scope="col">Sites</th>
                      <th scope="col">Fenêtre max</th>
                      <th scope="col">Détails</th>
                    </tr>
                  </thead>
                  <tbody id="resultsBody">
                    <tr>
                      <td colspan="5" class="fr-text--sm fr-hint-text">Aucun résultat pour le moment.</td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <p class="fr-text--xs fr-hint-text fr-mt-2w">
                * La portabilité / changement de plaques / incertitudes de saisie peuvent fausser les corrélations. Vérifie toujours avec tes sources.
              </p>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <footer class="fr-footer" role="contentinfo">
    <div class="fr-container">
      <div class="fr-footer__body">
        <p class="fr-text--sm fr-mb-0">
          GoFast — Outil d’aide à la détection de convois de véhicules • Exécution locale navigateur
        </p>
      </div>
    </div>
  </footer>

  <!-- DSFR JS -->
  <script src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/dsfr/dsfr.min.js" defer></script>

  <script>
  "use strict";

  // ============================================================
  // CONFIG / ÉTAT
  // ============================================================
  const state = {
    files: [],
    rows: [],       // lignes normalisées (toutes sources confondues)
    groups: []      // groupes de convoi détectés
  };

  const els = {
    fileInput: document.getElementById("fileInput"),
    dropzone: document.getElementById("dropzone"),
    fileList: document.getElementById("fileList"),
    btnParse: document.getElementById("btnParse"),
    btnReset: document.getElementById("btnReset"),
    btnDemo: document.getElementById("btnDemo"),
    thresholdSeconds: document.getElementById("thresholdSeconds"),
    minVehicles: document.getElementById("minVehicles"),
    minSites: document.getElementById("minSites"),
    toggleStrictOrder: document.getElementById("toggleStrictOrder"),
    resultsBody: document.getElementById("resultsBody"),
    statusBadge: document.getElementById("statusBadge"),
    statsText: document.getElementById("statsText"),
  };

  function setStatus(type, text) {
    // type: info | success | warning | error
    const map = {
      info: "fr-badge--info",
      success: "fr-badge--success",
      warning: "fr-badge--warning",
      error: "fr-badge--error"
    };
    els.statusBadge.className = "fr-badge " + (map[type] || map.info);
    els.statusBadge.textContent = text;
  }

  // ============================================================
  // UTILITAIRES
  // ============================================================
  function normalizePlate(plate) {
    if (!plate) return "";
    return String(plate).toUpperCase().replace(/[^A-Z0-9]/g, "");
  }

  function safeTrim(s) {
    return (s ?? "").toString().trim();
  }

  function parseDateToMs(input) {
    // v1: essaie ISO ou formats classiques. Ajustera selon tes exports.
    const s = safeTrim(input);
    if (!s) return NaN;

    // ISO direct
    const t = Date.parse(s);
    if (!Number.isNaN(t)) return t;

    // Format FR dd/mm/yyyy hh:mm:ss
    const m = s.match(/^(\d{2})[\/\-](\d{2})[\/\-](\d{4})(?:\s+(\d{2}):(\d{2})(?::(\d{2}))?)?$/);
    if (m) {
      const dd = +m[1], mm = +m[2] - 1, yyyy = +m[3];
      const HH = +(m[4] || 0), MM = +(m[5] || 0), SS = +(m[6] || 0);
      return new Date(yyyy, mm, dd, HH, MM, SS).getTime();
    }
    return NaN;
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[c]));
  }

  // ============================================================
  // MODULE PARSER (CSV ultra simple v1)
  // ============================================================
  function splitCsvLine(line) {
    // CSV simple: gère guillemets basiques. Suffisant v1.
    const out = [];
    let cur = "", inQ = false;
    for (let i = 0; i < line.length; i++) {
      const ch = line[i];
      if (ch === '"') {
        if (inQ && line[i+1] === '"') { cur += '"'; i++; }
        else inQ = !inQ;
      } else if (ch === ";" && !inQ) {
        out.push(cur); cur = "";
      } else if (ch === "," && !inQ) {
        // certains exports sont en virgule
        out.push(cur); cur = "";
      } else {
        cur += ch;
      }
    }
    out.push(cur);
    return out.map(v => safeTrim(v));
  }

  function detectDelimiter(headerLine) {
    // petite heuristique
    const semi = (headerLine.match(/;/g) || []).length;
    const comma = (headerLine.match(/,/g) || []).length;
    return semi >= comma ? ";" : ",";
  }

  function parseCsv(text) {
    const lines = text.replace(/\r/g, "").split("\n").filter(l => l.trim().length);
    if (lines.length < 2) return [];

    const delim = detectDelimiter(lines[0]);
    const split = (line) => {
      // reuse splitCsvLine but force delimiter by replacing other with sentinel
      // simple: if delim=";" keep ; else keep ,
      if (delim === ";") return splitCsvLine(line.replace(/,/g, "§")).map(x => x.replace(/§/g, ","));
      return splitCsvLine(line.replace(/;/g, "§")).map(x => x.replace(/§/g, ";"));
    };

    const headers = split(lines[0]).map(h => h.toLowerCase());
    const rows = [];

    for (let i = 1; i < lines.length; i++) {
      const cols = split(lines[i]);
      const obj = {};
      headers.forEach((h, idx) => obj[h] = cols[idx] ?? "");
      rows.push(obj);
    }
    return rows;
  }

  function normalizeRow(raw, sourceName) {
    // v1: on cherche des champs “plaque”, “immat”, “date”, “heure”, “lieu”, “site”
    const keys = Object.keys(raw);

    const get = (...candidates) => {
      for (const c of candidates) {
        const k = keys.find(k => k.includes(c));
        if (k) return raw[k];
      }
      return "";
    };

    const plate = normalizePlate(get("plaque","immat","immatric","immatriculation","plate"));
    const dateStr = get("date_heure","datetime","dateheure","horodatage","date","heure","timestamp");
    const site = safeTrim(get("lieu","site","point","poste","peage","péage","lapi","camera","caméra","localisation","adresse"));

    const ts = parseDateToMs(dateStr);

    if (!plate || Number.isNaN(ts) || !site) return null;

    return {
      plate,
      ts,
      site,
      source: sourceName || "import",
      raw
    };
  }

  async function readFileAsText(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(String(reader.result || ""));
      reader.onerror = () => reject(reader.error);
      reader.readAsText(file, "utf-8");
    });
  }

  // ============================================================
  // MODULE ENGINE (détection v1)
  // ============================================================
  function detectGroups(rows, cfg) {
    // rows: [{plate, ts, site, ...}]
    // cfg: {thresholdSeconds, minVehicles}
    const thr = cfg.thresholdSeconds * 1000;
    const minV = cfg.minVehicles;

    // index par site
    const bySite = new Map();
    for (const r of rows) {
      if (!bySite.has(r.site)) bySite.set(r.site, []);
      bySite.get(r.site).push(r);
    }
    // tri par temps
    for (const [site, arr] of bySite.entries()) {
      arr.sort((a,b) => a.ts - b.ts);
    }

    const groups = [];
    for (const [site, arr] of bySite.entries()) {
      // fenêtre glissante
      let start = 0;
      for (let end = 0; end < arr.length; end++) {
        while (arr[end].ts - arr[start].ts > thr) start++;

        // collecte uniques
        const window = arr.slice(start, end + 1);
        const uniq = new Map(); // plate -> first seen in window
        for (const w of window) if (!uniq.has(w.plate)) uniq.set(w.plate, w);

        if (uniq.size >= minV) {
          const vehicles = [...uniq.values()].sort((a,b) => a.ts - b.ts);
          groups.push({
            site,
            tMin: vehicles[0].ts,
            tMax: vehicles[vehicles.length - 1].ts,
            vehicles, // array of row
          });
        }
      }
    }
    return groups;
  }

  // ============================================================
  // MODULE SCORING (v1 simple)
  // ============================================================
  function scoreAndMerge(groups, cfg) {
    // v1: fusion grossière par "set de plaques" sur différents sites
    const minSites = cfg.minSites;
    const strictOrder = cfg.strictOrder;

    const keyFor = (g) => g.vehicles.map(v => v.plate).sort().join("|");
    const merged = new Map();

    for (const g of groups) {
      const key = keyFor(g);
      if (!merged.has(key)) {
        merged.set(key, {
          key,
          plates: g.vehicles.map(v => v.plate).sort(),
          sites: new Set(),
          occurrences: [],
        });
      }
      const m = merged.get(key);
      m.sites.add(g.site);
      m.occurrences.push(g);
    }

    const out = [];
    for (const m of merged.values()) {
      const sitesCount = m.sites.size;
      if (sitesCount < minSites) continue;

      // score v1 : occurrences * sites * bonus si ordre stable
      let score = m.occurrences.length * sitesCount;

      if (strictOrder) {
        // bonus si la première plaque (chronologique) revient souvent la même sur les occurrences
        const firsts = m.occurrences.map(o => o.vehicles[0]?.plate).filter(Boolean);
        const mode = firsts.sort((a,b)=>
          firsts.filter(x=>x===b).length - firsts.filter(x=>x===a).length
        )[0];
        const stability = firsts.filter(x => x === mode).length / Math.max(1, firsts.length);
        score += Math.round(stability * 5);
      }

      out.push({
        score,
        plates: m.plates,
        sitesCount,
        occurrences: m.occurrences
      });
    }

    out.sort((a,b) => b.score - a.score);
    return out;
  }

  // ============================================================
  // MODULE UI
  // ============================================================
  function renderFileList() {
    els.fileList.innerHTML = "";
    for (const f of state.files) {
      const li = document.createElement("li");
      li.textContent = `${f.name} (${Math.round(f.size/1024)} Ko)`;
      els.fileList.appendChild(li);
    }
    els.btnParse.disabled = state.files.length === 0;
  }

  function renderResults(results, cfg) {
    if (!results.length) {
      els.resultsBody.innerHTML = `
        <tr><td colspan="5" class="fr-text--sm fr-hint-text">Aucun convoi détecté avec ces paramètres.</td></tr>
      `;
      return;
    }

    els.resultsBody.innerHTML = results.map((r, idx) => {
      const maxWindowMs = Math.max(...r.occurrences.map(o => o.tMax - o.tMin));
      const maxWindowSec = Math.round(maxWindowMs / 1000);

      const details = r.occurrences
        .slice(0, 3)
        .map(o => `${escapeHtml(o.site)} (${new Date(o.tMin).toLocaleString()} → ${new Date(o.tMax).toLocaleTimeString()})`)
        .join("<br>");

      const more = r.occurrences.length > 3 ? `<br><span class="fr-text--xs fr-hint-text">+ ${r.occurrences.length - 3} autres</span>` : "";

      return `
        <tr>
          <td><strong>${r.score}</strong></td>
          <td>${escapeHtml(r.plates.join(", "))}</td>
          <td>${r.sitesCount}</td>
          <td>${maxWindowSec}s</td>
          <td class="fr-text--sm">${details}${more}</td>
        </tr>
      `;
    }).join("");
  }

  function getConfig() {
    return {
      thresholdSeconds: Number(els.thresholdSeconds.value || 90),
      minVehicles: Number(els.minVehicles.value || 3),
      minSites: Number(els.minSites.value || 2),
      strictOrder: !!els.toggleStrictOrder.checked
    };
  }

  function resetAll() {
    state.files = [];
    state.rows = [];
    state.groups = [];
    els.fileInput.value = "";
    renderFileList();
    els.statsText.textContent = "";
    setStatus("info", "En attente d’import");
    els.resultsBody.innerHTML = `<tr><td colspan="5" class="fr-text--sm fr-hint-text">Aucun résultat pour le moment.</td></tr>`;
  }

  // ============================================================
  // ÉVÈNEMENTS
  // ============================================================
  els.fileInput.addEventListener("change", (e) => {
    const files = [...(e.target.files || [])];
    state.files = files;
    renderFileList();
    setStatus(files.length ? "info" : "info", files.length ? "Fichiers prêts" : "En attente d’import");
  });

  // Drag & drop
  ["dragenter","dragover"].forEach(evt =>
    els.dropzone.addEventListener(evt, (e) => {
      e.preventDefault(); e.stopPropagation();
      els.dropzone.style.borderColor = "var(--border-action-high-blue-france)";
    })
  );
  ["dragleave","drop"].forEach(evt =>
    els.dropzone.addEventListener(evt, (e) => {
      e.preventDefault(); e.stopPropagation();
      els.dropzone.style.borderColor = "var(--border-default-grey)";
    })
  );
  els.dropzone.addEventListener("drop", (e) => {
    const files = [...(e.dataTransfer.files || [])].filter(f => f.name.toLowerCase().endsWith(".csv"));
    if (files.length) {
      state.files = files;
      renderFileList();
      setStatus("info", "Fichiers prêts");
    }
  });

  els.btnReset.addEventListener("click", resetAll);

  els.btnDemo.addEventListener("click", async () => {
    // v1: démo en mémoire (pas de fichier)
    const demo = [
      { plaque:"AA-123-AA", date_heure:"2026-02-12 10:01:10", site:"LAPI A6 - PK12" },
      { plaque:"BB-456-BB", date_heure:"2026-02-12 10:01:40", site:"LAPI A6 - PK12" },
      { plaque:"CC-789-CC", date_heure:"2026-02-12 10:02:05", site:"LAPI A6 - PK12" },

      { plaque:"AA-123-AA", date_heure:"2026-02-12 10:24:10", site:"Péage X" },
      { plaque:"BB-456-BB", date_heure:"2026-02-12 10:24:50", site:"Péage X" },
      { plaque:"CC-789-CC", date_heure:"2026-02-12 10:25:20", site:"Péage X" },
    ];
    state.rows = demo.map(r => normalizeRow(r, "demo")).filter(Boolean);
    setStatus("success", "Démo chargée");
    els.statsText.textContent = `${state.rows.length} passages normalisés`;

    const cfg = getConfig();
    const rawGroups = detectGroups(state.rows, cfg);
    const results = scoreAndMerge(rawGroups, cfg);
    renderResults(results, cfg);
  });

  els.btnParse.addEventListener("click", async () => {
    if (!state.files.length) return;
    setStatus("info", "Analyse en cours…");
    els.statsText.textContent = "";

    try {
      const allRows = [];
      for (const f of state.files) {
        const txt = await readFileAsText(f);
        const parsed = parseCsv(txt);
        for (const r of parsed) {
          const n = normalizeRow(r, f.name);
          if (n) allRows.push(n);
        }
      }

      state.rows = allRows;
      const cfg = getConfig();

      const rawGroups = detectGroups(state.rows, cfg);
      const results = scoreAndMerge(rawGroups, cfg);

      setStatus("success", "Analyse terminée");
      els.statsText.textContent = `${state.rows.length} passages normalisés • ${results.length} groupes`;

      renderResults(results, cfg);
    } catch (err) {
      console.error(err);
      setStatus("error", "Erreur d’analyse");
      els.statsText.textContent = String(err?.message || err);
    }
  });

  // Init
  resetAll();
  </script>
</body>
</html>
