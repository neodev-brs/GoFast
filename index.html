<!DOCTYPE html>
<html lang="fr" data-fr-scheme="system">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script>
  ;(function () {
    try {
      var saved = localStorage.getItem('scheme');
      if (saved) document.documentElement.setAttribute('data-fr-scheme', saved);
    } catch (e) {}
  })();
</script>
  <title>GoFast - Outil de détection des convois de véhicules</title>

  <!-- Favicon (DSFR) -->
  <link rel="icon" type="image/png"
        href="https://www.interieur.gouv.fr/themes/custom/dsfr/src/images/logo/favicon.png">

  <!-- DSFR -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/dsfr/dsfr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/dsfr/utility/utilities.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/utility/icons/icons.min.css">

<!-- STYLE-->
<style>
  /* GoFast – on neutralise le layout "marketing card" DSFR qui pousse le contenu en bas */
  #import .fr-card__body,
  #parametres .fr-card__body,
  #resultats .fr-card__body{
    display: block !important;
  }

  #import .fr-card__content,
  #parametres .fr-card__content,
  #resultats .fr-card__content{
    display: block !important;     /* <= le plus robuste : plus de flex */
    height: auto !important;
  }

  /* Bonus : évite les marges qui donnent l’impression que ça "descend" */
  #import .fr-card__title,
  #parametres .fr-card__title,
  #resultats .fr-card__title{
    margin-top: 0 !important;
  }

/* 1) Si le navigateur utilise le backdrop natif du <dialog> */
#fr-theme-modal::backdrop {
  background: rgba(0, 0, 0, 0.35);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
}

/* 3) On remet le contenu au-dessus */
#fr-theme-modal[open] .fr-modal__body {
  position: relative;
  z-index: 1;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
}

/* Enlève le contour/halo focus DSFR uniquement sur le bouton "Paramètres d’affichage" */
#btnTheme:focus,
#btnTheme:focus-visible {
  outline: none !important;
  box-shadow: none !important;
}

/* Au repos : enlève toute bordure visible si le style tertiary/display en met une */
#btnTheme {
  border: 0 !important;
}

/* Centre verticalement la modale thème */
#fr-theme-modal[open] {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 2rem; /* évite que ça colle aux bords sur petit écran */
}

/* DSFR a parfois un alignement haut via la grille -> on neutralise */
#fr-theme-modal .fr-grid-row{
  margin-top: 0 !important;
}

/* Evite que la modale dépasse en hauteur (petits écrans) */
#fr-theme-modal .fr-modal__body{
  max-height: calc(100vh - 4rem);
  overflow: auto;
}

/* Centrage vertical/hor. SANS casser DSFR (on ne touche pas au <dialog>) */
#fr-theme-modal[open] .fr-container--fluid {
  min-height: 100vh;              /* plein écran */
  display: flex;
  align-items: center;            /* centre vertical */
  justify-content: center;        /* centre horizontal */
}

/* La grille DSFR peut ajouter des marges/alignements, on neutralise */
#fr-theme-modal[open] .fr-grid-row {
  width: 100%;
  margin-top: 0 !important;
  margin-bottom: 0 !important;
}

/* évite que la modale dépasse sur petit écran */
#fr-theme-modal .fr-modal__body {
  max-height: calc(100vh - 4rem);
  overflow: auto;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15); /* tu peux garder */
}

#fr-theme-modal::backdrop {
  background: rgba(0,0,0,.35);
}

/* Supprime définitivement la bordure du bouton Paramètres d'affichage */
#btnTheme.fr-btn--tertiary {
  border: none !important;
}

#btnTheme {
  border: none !important;
  box-shadow: none !important;
}

/* Enlève l'icône DSFR devant le texte dans NOS badges score */
.gofast-bubble::before{
  display: none !important;
  content: none !important;
}

.gofast-score-wrap{
  display:inline-flex;
  flex-direction:column;
  align-items:center;   /* centre le texte */
  gap:.25rem;
}

.gofast-score-level{
  font-size:.75rem;
  opacity:.8;
}

/* Colonnes étroites */
.col-small{
  width:80px;
  white-space:nowrap;
  text-align:center;
}

/* Colonne lieu */
.col-lieu{
  width:180px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* Détails sur une seule ligne */
.col-details{
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* Centre tout le contenu du tableau résultats */
#resultats table th,
#resultats table td{
  text-align: center;
  vertical-align: middle;
}

/* Empêche le retour à la ligne pour la colonne Probabilité */
#resultats table th:first-child,
#resultats table td:first-child{
  white-space: nowrap;
}

/* Empêche le retour à la ligne pour Fenêtre max */
#resultats table th:nth-child(4),
#resultats table td:nth-child(4){
  white-space: nowrap;
}

.gofast-timeline-wrap{
  width: 100%;
  border: 1px solid var(--border-default-grey);
  border-radius: 8px;
  padding: 8px;
  background: var(--background-default-grey);
  overflow: hidden;
}

.gofast-timeline{
  width: 100%;
  height: 320px;
  display: block;
  background: var(--background-default-grey);
}

.gofast-tl-label{
  font: 12px Marianne, Arial, sans-serif;
  fill: var(--text-default-grey);
}

.gofast-tl-axis{
  stroke: var(--border-default-grey);
  stroke-width: 1;
}

.gofast-tl-dot{
  stroke: var(--border-default-grey);
  stroke-width: 1;
}

.gofast-tl-line{
  stroke: var(--border-default-grey);
  stroke-width: 1;
}

.gofast-result-row{ cursor: pointer; }

.gofast-result-row:focus{ outline: 2px solid var(--border-action-high-blue-france); outline-offset: -2px; }

.gofast-timeline-wrap{ position: relative; }

.gofast-tooltip{
  position:absolute;
  z-index: 5;
  display:none;
  pointer-events:none;
  max-width: 360px;
  padding: .5rem .75rem;
  border-radius: .5rem;
  border: 1px solid var(--border-default-grey);
  background: var(--background-default-grey);
  color: var(--text-default-grey);
  box-shadow: 0 8px 24px rgba(0,0,0,.12);
  font: 12px Marianne, Arial, sans-serif;
}

.gofast-tl-dot.is-hover{
  stroke: var(--border-action-high-blue-france);
  stroke-width: 2;
}

.gofast-tl-row.is-dim{ opacity: .25; }

#gaps .fr-card__content{
  display: block !important;
}

.gofast-gap-title{
  font: 12px Marianne, Arial, sans-serif;
  fill: var(--text-default-grey);
  opacity: .9;
}
.gofast-gap-sub{
  font: 11px Marianne, Arial, sans-serif;
  fill: var(--text-mention-grey);
}
.gofast-gap-tick{
  font: 11px Marianne, Arial, sans-serif;
  fill: var(--text-mention-grey);
}

#orderBadge { white-space: nowrap; }
#orderHelp { opacity: .85; }

#rapport .fr-card__content{
  display:block !important;
}

/* Rapport : lisibilité */
#rapportTexte{
  line-height: 1.7;
  white-space: pre-wrap;
}

/* Petit “rythme” entre paragraphes (si tu mets des lignes vides dans le texte) */
#rapport .fr-card__desc{ margin-bottom: 1rem; }

</style>

</head>

<body>
  <!-- HEADER DSFR -->
  <header role="banner" class="fr-header">
    <div class="fr-header__body">
      <div class="fr-container">
        <div class="fr-header__body-row">
          <div class="fr-header__brand fr-enlarge-link">
            <div class="fr-header__brand-top">
              <div class="fr-header__logo">
                <p class="fr-logo">
                  Ministère<br>de l’Intérieur
                </p>
              </div>
              <div class="fr-header__navbar">
                <button class="fr-btn--menu fr-btn" data-fr-opened="false" aria-controls="modal-menu" aria-haspopup="menu" title="Menu">
                  Menu
                </button>
              </div>
            </div>

            <div class="fr-header__service">
              <a href="#" title="Accueil">
                <p class="fr-header__service-title">GoFast</p>
              </a>
              <p class="fr-header__service-tagline">Outil de détection des convois de véhicules</p>
            </div>
          </div>

          <div class="fr-header__tools">
            <div class="fr-header__tools-links">
              <ul class="fr-btns-group fr-btns-group--sm">
                <li>
                  <button id="btnDemo" class="fr-btn fr-btn--secondary">Démonstration</button>
                </li>
                <li>
                  <button id="btnReset" class="fr-btn fr-btn--secondary">Réinitialiser</button>
                </li>
                <li>
                  <button id="btnTheme" class="fr-btn fr-btn--tertiary fr-btn--display"
                          aria-controls="fr-theme-modal"
                          data-fr-opened="false"
                          title="Paramètres d'affichage"
                          type="button">
                    Paramètres d’affichage
                  </button>
                </li>
              </ul>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- MENU (optionnel) -->
    <div class="fr-header__menu fr-modal" id="modal-menu" aria-labelledby="modal-menu-title">
      <div class="fr-container">
        <button class="fr-btn--close fr-btn" aria-controls="modal-menu" title="Fermer">Fermer</button>
        <div class="fr-header__menu-links"></div>
        <nav class="fr-nav" role="navigation" aria-label="Menu principal">
          <ul class="fr-nav__list">
            <li class="fr-nav__item"><a class="fr-nav__link" href="#import">Analyse</a></li>
            <li class="fr-nav__item"><a class="fr-nav__link" href="#resultats">Résultats</a></li>
          </ul>
        </nav>
      </div>
    </div>
  </header>

  <main class="fr-container fr-my-4w">

    <!-- GRID -->
    <div class="fr-grid-row fr-grid-row--gutters">

      <!-- IMPORT -->
      <div class="fr-col-12 fr-col-lg-6" id="import">
        <div class="fr-card fr-card--no-arrow">
          <div class="fr-card__body">
            <div class="fr-card__content">
              <h3 class="fr-card__title">Import des fichiers</h3>
              <p class="fr-card__desc">
                Importe un ou plusieurs fichiers CSV (LAPI, péage, exports, etc.).
              </p>

              <div class="fr-upload-group fr-mt-2w">
                <label class="fr-label" for="fileInput">
                  Sélectionner des fichiers CSV
                  <span class="fr-hint-text">Format CSV recommandé (UTF-8). Tu peux en sélectionner plusieurs.</span>
                </label>
                <input class="fr-upload" type="file" id="fileInput" accept=".csv,text/csv" multiple />
              </div>

              <div id="dropzone" class="fr-mt-2w fr-p-2w"
                   style="border: 2px dashed var(--border-default-grey); border-radius: 8px;">
                <strong>Glisse-dépose</strong> tes fichiers ici
                <div class="fr-hint-text fr-mt-1v">Astuce : tu peux aussi déposer des fichiers directement depuis l’explorateur.</div>
              </div>

              <div class="fr-mt-2w">
                <button id="btnParse" class="fr-btn" disabled>Analyser les fichiers</button>
              </div>

              <div class="fr-mt-2w">
                <p class="fr-text--sm fr-mb-1v"><strong>Fichiers chargés :</strong></p>
                <ul id="fileList" class="fr-m-0 fr-pl-2w"></ul>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- PARAMÈTRES -->
      <div class="fr-col-12 fr-col-lg-6" id="parametres">
        <div class="fr-card fr-card--no-arrow">
          <div class="fr-card__body">
            <div class="fr-card__content">
              <h3 class="fr-card__title">Paramètres</h3>
              <p class="fr-card__desc">Ajuste les seuils de détection.</p>

              <div class="fr-input-group">
                <label class="fr-label" for="thresholdSeconds">
                  Seuil temporel (secondes)
                  <span class="fr-hint-text">Intervalle max entre véhicules pour considérer un co-passage.</span>
                </label>
                <input class="fr-input" type="number" id="thresholdSeconds" min="5" max="900" step="5" value="90" />
              </div>

              <div class="fr-input-group">
                <label class="fr-label" for="minVehicles">
                  Nombre minimal de véhicules
                  <span class="fr-hint-text">2 = duo suspect, 3 = ouvreuse/porteuse/suiveuse.</span>
                </label>
                <input class="fr-input" type="number" id="minVehicles" min="2" max="10" step="1" value="3" />
              </div>

              <div class="fr-input-group">
                <label class="fr-label" for="minSites">
                  Nombre minimal de sites (lieux)
                  <span class="fr-hint-text">Répétition sur plusieurs lieux = suspicion renforcée.</span>
                </label>
                <input class="fr-input" type="number" id="minSites" min="1" max="50" step="1" value="2" />
              </div>

              <div class="fr-toggle fr-mt-2w">
                <input type="checkbox" class="fr-toggle__input" id="toggleStrictOrder" checked>
                <label class="fr-toggle__label" for="toggleStrictOrder">
                  Favoriser l’ordre stable (ouvreuse → porteuse → suiveuse)
                </label>
              </div>

              <div class="fr-mt-2w fr-text--sm fr-hint-text">
                Note : GoFast met en évidence des corrélations. Il ne “décide” pas à ta place.
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- RÉSULTATS -->
      <div class="fr-col-12" id="resultats">
        <div class="fr-card fr-enlarge-link fr-card--no-arrow">
          <div class="fr-card__body">
            <div class="fr-card__content">
              <h3 class="fr-card__title">Résultats</h3>
              <p class="fr-card__desc">
                Groupes détectés, triés par pourcentage de probabilité décroissant.
              </p>

              <div class="fr-grid-row fr-grid-row--middle fr-mb-2w">

                <!-- Badge + stats à gauche -->
                <div class="fr-col">
                  <span class="fr-badge fr-badge--info" id="statusBadge">En attente d’import</span>
                  <span class="fr-ml-2w fr-text--sm fr-hint-text" id="statsText"></span>
                </div>

                <!-- Toggle à droite -->
                <div class="fr-col-auto">
                  <div class="fr-toggle fr-toggle--sm fr-m-0">
                    <input type="checkbox" class="fr-toggle__input" id="toggleModeEnquete">
                    <label class="fr-toggle__label" for="toggleModeEnquete">
                      Détails
                    </label>
                  </div>
                </div>

              </div>

              <div class="fr-table fr-table--bordered fr-table--layout-fixed">
                <table>
                    <colgroup>
                      <col style="width:140px">   <!-- % -->
                      <col style="width:220px">   <!-- Véhicules -->
                      <col style="width:70px">    <!-- Sites -->
                      <col style="width:90px">    <!-- Fenêtre max -->
                      <col style="width:160px">   <!-- Lieu -->
                      <col>                       <!-- Détails = prend tout le reste -->
                    </colgroup>
                  <thead>
                    <tr>
                      <th scope="col">Probabilité (en %)</th>
                      <th scope="col">Véhicules</th>
                      <th scope="col">Sites</th>
                      <th scope="col">Fenêtre max</th>
                      <th scope="col">Lieu</th>
                      <th scope="col">Détails</th>
                    </tr>
                  </thead>
                  <tbody id="resultsBody">
                    <tr>
                      <td colspan="6" class="fr-text--sm fr-hint-text">Aucun résultat pour le moment.</td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <p class="fr-text--xs fr-hint-text fr-mt-2w">
                * La portabilité / changement de plaques / incertitudes de saisie peuvent fausser les corrélations. Vérifie toujours avec tes sources.
              </p>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- STABILITÉ D’ORDRE -->
<div class="fr-col-12" id="ordre">
  <div class="fr-card fr-card--no-arrow">
    <div class="fr-card__body">
      <div class="fr-card__content">

        <div class="fr-grid-row fr-grid-row--middle fr-mb-1w">
          <div class="fr-col">
            <h3 class="fr-card__title">Stabilité d’ordre</h3>
            <p class="fr-card__desc" id="orderDesc">
              Mesure si le même véhicule ouvre/ferme le groupe sur les occurrences.
            </p>
          </div>
          <div class="fr-col-auto">
            <span class="fr-badge fr-badge--info" id="orderBadge">—</span>
          </div>
        </div>

        <div class="fr-progress fr-mb-1w" aria-label="Stabilité d’ordre">
          <div id="orderProgress" class="fr-progress__bar" style="width:0%"></div>
          <span id="orderValue" class="fr-progress__label">—</span>
        </div>

        <p class="fr-text--sm fr-m-0" id="orderHelp">
          Sélectionne une ligne de résultat pour afficher l’indicateur.
        </p>

      </div>
    </div>
  </div>
</div>

    <!-- TIMELINE -->
<div class="fr-col-12" id="timeline">
  <div class="fr-card fr-card--no-arrow">
    <div class="fr-card__body">
      <div class="fr-card__content">
        <div class="fr-grid-row fr-grid-row--middle fr-mb-2w">
          <div class="fr-col">
            <h3 class="fr-card__title">Timeline</h3>
            <p class="fr-card__desc">
              Visualisation temporelle des passages (sélectionne un groupe dans le tableau).
            </p>
          </div>
        </div>

        <div class="fr-alert fr-alert--info fr-mb-2w" id="timelineHint">
          <p>Sélectionne une ligne de résultat pour afficher la timeline.</p>
        </div>

        <div class="gofast-timeline-wrap">
          <svg id="timelineSvg" class="gofast-timeline" viewBox="0 0 1000 320" preserveAspectRatio="none" aria-label="Timeline des passages"></svg>
          <div id="timelineTooltip" class="gofast-tooltip" role="status" aria-live="polite"></div>
        </div>

        <p class="fr-text--xs fr-hint-text fr-mt-2w" id="timelineLegend"></p>
      </div>
    </div>
  </div>
</div>

<!-- RAPPORT -->
<div class="fr-col-12" id="rapport">
  <div class="fr-card fr-card--no-arrow">
    <div class="fr-card__body">
      <div class="fr-card__content">
        <div class="fr-grid-row fr-grid-row--middle fr-mb-2w">
          <div class="fr-col">
            <h3 class="fr-card__title">Rapport d’analyse</h3>
            <p class="fr-card__desc">
              Qualification automatique du phénomène (sélectionne un groupe dans le tableau).
            </p>
          </div>
        </div>

        <div class="fr-alert fr-alert--info fr-mb-2w" id="rapportHint">
          <p>Sélectionne une ligne de résultat pour afficher le rapport.</p>
        </div>

        <!-- TEXTE COPIABLE -->
        <div id="rapportTexte" class="fr-text--sm fr-mb-3w" style="white-space: pre-wrap;">
          —
        </div>

        <!-- Bouton copier en bas à droite -->
        <div class="fr-btns-group fr-btns-group--right fr-btns-group--inline">
          <button class="fr-btn fr-btn--secondary" id="btnCopierRapport" type="button" disabled>
            Copier
          </button>
        </div>

        <!-- Message succès -->
        <div id="copieOk" class="fr-alert fr-alert--success fr-mt-2w" style="display:none;">
          <p>Rapport copié dans le presse-papiers.</p>
        </div>

      </div>
    </div>
  </div>
</div>

  </main>

<dialog id="fr-theme-modal" class="fr-modal" aria-labelledby="fr-theme-modal-title">
  <div class="fr-container fr-container--fluid fr-container-md">
    <div class="fr-grid-row fr-grid-row--center">
      <div class="fr-col-12 fr-col-md-6 fr-col-lg-4">
        <div class="fr-modal__body">
          <div class="fr-modal__header">
            <button aria-controls="fr-theme-modal" title="Fermer" type="button" class="fr-btn--close fr-btn">Fermer</button>
          </div>

          <div class="fr-modal__content">
            <h1 id="fr-theme-modal-title" class="fr-modal__title">Paramètres d’affichage</h1>

            <div id="fr-display" class="fr-display">
              <fieldset class="fr-fieldset" id="display-fieldset">
                <legend class="fr-fieldset__legend--regular fr-fieldset__legend" id="display-fieldset-legend">
                  Choisissez un thème pour personnaliser l’apparence du site.
                </legend>

                <div class="fr-fieldset__element">
                  <div class="fr-radio-group fr-radio-rich">
                    <input value="light" type="radio" id="fr-radios-theme-light" name="fr-radios-theme">
                    <label class="fr-label" for="fr-radios-theme-light">Thème clair</label>
                    <div class="fr-radio-rich__pictogram" aria-hidden="true">
                      <img alt="" width="80" height="80"
                          src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/artwork/pictograms/environment/sun.svg">
                    </div>
                  </div>
                </div>

                <div class="fr-fieldset__element">
                  <div class="fr-radio-group fr-radio-rich">
                    <input value="dark" type="radio" id="fr-radios-theme-dark" name="fr-radios-theme">
                    <label class="fr-label" for="fr-radios-theme-dark">Thème sombre</label>
                    <div class="fr-radio-rich__pictogram" aria-hidden="true">
                      <img alt="" width="80" height="80"
                          src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/artwork/pictograms/environment/moon.svg">
                    </div>
                  </div>
                </div>

                <div class="fr-fieldset__element">
                  <div class="fr-radio-group fr-radio-rich">
                    <input value="system" type="radio" id="fr-radios-theme-system" name="fr-radios-theme">
                    <label class="fr-label" for="fr-radios-theme-system">
                      Système <span class="fr-hint-text">Utilise les paramètres système</span>
                    </label>
                    <div class="fr-radio-rich__pictogram" aria-hidden="true">
                      <img alt="" width="80" height="80"
                          src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/artwork/pictograms/system/system.svg">
                    </div>
                  </div>
                </div>

              </fieldset>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
</dialog>

  <!-- DSFR JS -->
  <script type="module" src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/dsfr/dsfr.module.min.js"></script>
  <script nomodule src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/dsfr/dsfr.nomodule.min.js"></script>

  <script>
;(function () {
  const radios = document.querySelectorAll('input[name="fr-radios-theme"]');
  const btn = document.getElementById('btnTheme');
  if (!radios.length) return;

  function getCurrentScheme() {
    try {
      return localStorage.getItem('scheme')
        || document.documentElement.getAttribute('data-fr-scheme')
        || 'system';
    } catch (e) {
      return document.documentElement.getAttribute('data-fr-scheme') || 'system';
    }
  }

  function syncRadios() {
    const scheme = getCurrentScheme();
    radios.forEach(r => r.checked = (r.value === scheme));
  }

  syncRadios();
  if (btn) btn.addEventListener('click', syncRadios);
})();
</script>

  <script>
  "use strict";

  // ============================================================
  // CONFIG / ÉTAT
  // ============================================================
  const state = {
    files: [],
    rows: [],       // lignes normalisées (toutes sources confondues)
    groups: [],      // groupes de convoi détectés
    rawGroups: [],
    results: [],
    hasSeenEnquete: false,
    selectedResultIndex: -1,
  };

  const els = {
    fileInput: document.getElementById("fileInput"),
    dropzone: document.getElementById("dropzone"),
    fileList: document.getElementById("fileList"),
    btnParse: document.getElementById("btnParse"),
    btnReset: document.getElementById("btnReset"),
    btnDemo: document.getElementById("btnDemo"),
    thresholdSeconds: document.getElementById("thresholdSeconds"),
    minVehicles: document.getElementById("minVehicles"),
    minSites: document.getElementById("minSites"),
    toggleStrictOrder: document.getElementById("toggleStrictOrder"),
    resultsBody: document.getElementById("resultsBody"),
    statusBadge: document.getElementById("statusBadge"),
    statsText: document.getElementById("statsText"),
    toggleModeEnquete: document.getElementById("toggleModeEnquete"),
    rapportTexte: document.getElementById("rapportTexte"),
    rapportHint: document.getElementById("rapportHint"),
    btnCopierRapport: document.getElementById("btnCopierRapport"),
    copieOk: document.getElementById("copieOk"),
  };

  function setStatus(type, text) {
    // type: info | success | warning | error
    const map = {
      info: "fr-badge--info",
      success: "fr-badge--success",
      warning: "fr-badge--warning",
      error: "fr-badge--error"
    };
    els.statusBadge.className = "fr-badge " + (map[type] || map.info);
    els.statusBadge.textContent = text;
  }

  // ============================================================
  // UTILITAIRES
  // ============================================================
  function normalizePlate(plate) {
    if (!plate) return "";
    return String(plate).toUpperCase().replace(/[^A-Z0-9]/g, "");
  }

  function safeTrim(s) {
    return (s ?? "").toString().trim();
  }

  function normalizeHeaderName(h) {
  // Nettoie : casse, espaces, accents, caractères
  return safeTrim(h)
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")  // enlève accents
    .replace(/[^\w]+/g, "_");                          // remplace tout le reste par _
}

  function parseDateToMs(input) {
    // v1: essaie ISO ou formats classiques. Ajustera selon tes exports.
    const s = safeTrim(input);
    if (!s) return NaN;

    // ISO direct
    const t = Date.parse(s);
    if (!Number.isNaN(t)) return t;

    // Format FR dd/mm/yyyy hh:mm:ss
    const m = s.match(/^(\d{2})[\/\-](\d{2})[\/\-](\d{4})(?:\s+(\d{2}):(\d{2})(?::(\d{2}))?)?$/);
    if (m) {
      const dd = +m[1], mm = +m[2] - 1, yyyy = +m[3];
      const HH = +(m[4] || 0), MM = +(m[5] || 0), SS = +(m[6] || 0);
      return new Date(yyyy, mm, dd, HH, MM, SS).getTime();
    }
    return NaN;
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[c]));
  }

  function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

function roundUpTo5(n) {
  if (!Number.isFinite(n)) return 0;
  n = clamp(n, 0, 100);
  return Math.min(100, Math.ceil(n / 5) * 5);
}

function scoreMeta(percentRaw) {
  const percent = roundUpTo5(percentRaw);

  let color, level;
  if (percent <= 30) {
    color = "success";
    level = "Corrélation faible";
  } else if (percent <= 70) {
    color = "warning";
    level = "Corrélation modérée";
  } else {
    color = "error";
    level = "Corrélation forte";
  }

  return { percent, color, level };
}

function toPercentSaturating(raw, k) {
  // raw >= 0 ; k règle la “vitesse” à laquelle on monte
  // percent = 100 * raw / (raw + k)  => jamais > 100
  raw = Math.max(0, Number(raw) || 0);
  k = Math.max(1, Number(k) || 10);
  return (100 * raw) / (raw + k);
}

function renderScoreBadgeHtml(percentRaw) {
  const { percent, color, level } = scoreMeta(percentRaw);
  return `
    <span class="gofast-score-wrap">
      <span class="fr-badge fr-badge--${color} gofast-bubble" title="${escapeHtml(level)}">${percent}%</span>
      <span class="gofast-score-level">${escapeHtml(level)}</span>
    </span>
  `;
}

  function normalizeRow(raw, sourceName) {
  const keys = Object.keys(raw);

  const get = (...candidates) => {
    for (const c of candidates) {
      const k = keys.find(k => k.includes(c));
      if (k) return raw[k];
    }
    return "";
  };

  const plate = normalizePlate(get("plaque","immat","immatric","immatriculation","plate"));

  // Date/heure : soit "date_heure", soit (date + heure)
  let dateStr =
    get("date_heure","datetime","dateheure","horodatage","timestamp");

  const d = safeTrim(get("date"));
  const h = safeTrim(get("heure","time"));
  if (!safeTrim(dateStr) && d) {
    dateStr = h ? `${d} ${h}` : d;
  }

  const site = safeTrim(get(
  "lieu","site","point","poste","peage","lapi","camera",
  "localisation","adresse"
));

  const ts = parseDateToMs(dateStr);

  if (!plate || Number.isNaN(ts) || !site) return null;

  return { plate, ts, site, source: sourceName || "import", raw };
}

// ============================================================
// MODULE PARSER
// ============================================================
function stripBom(s) {
  return s && s.charCodeAt(0) === 0xFEFF ? s.slice(1) : s;
}

function detectDelimiter(headerLine) {
  const line = headerLine || "";
  const semi = (line.match(/;/g) || []).length;
  const comma = (line.match(/,/g) || []).length;
  return semi >= comma ? ";" : ",";
}

function splitCsvLine(line, delim) {
  const out = [];
  let cur = "";
  let inQ = false;

  for (let i = 0; i < line.length; i++) {
    const ch = line[i];

    if (ch === '"') {
      // double quote escaped
      if (inQ && line[i + 1] === '"') {
        cur += '"';
        i++;
      } else {
        inQ = !inQ;
      }
      continue;
    }

    if (ch === delim && !inQ) {
      out.push(cur);
      cur = "";
      continue;
    }

    cur += ch;
  }

  out.push(cur);
  return out.map(v => safeTrim(v));
}

function parseCsv(text) {
  const raw = stripBom(String(text || "")).replace(/\r/g, "");
  const lines = raw.split("\n").filter(l => l.trim().length);
  if (lines.length < 2) return [];

  const delim = detectDelimiter(lines[0]);

  const headers = splitCsvLine(lines[0], delim)
    .map(h => normalizeHeaderName(h));

  const rows = [];
  for (let i = 1; i < lines.length; i++) {
    const cols = splitCsvLine(lines[i], delim);
    const obj = {};
    for (let c = 0; c < headers.length; c++) {
      obj[headers[c]] = cols[c] ?? "";
    }
    rows.push(obj);
  }
  return rows;
}

  // ============================================================
  // MODULE ENGINE (détection v1)
  // ============================================================
  function detectGroups(rows, cfg) {
    // rows: [{plate, ts, site, ...}]
    // cfg: {thresholdSeconds, minVehicles}
    const thr = cfg.thresholdSeconds * 1000;
    const minV = cfg.minVehicles;

    // index par site
    const bySite = new Map();
    for (const r of rows) {
      if (!bySite.has(r.site)) bySite.set(r.site, []);
      bySite.get(r.site).push(r);
    }
    // tri par temps
    for (const [site, arr] of bySite.entries()) {
      arr.sort((a,b) => a.ts - b.ts);
    }

    const groups = [];
    for (const [site, arr] of bySite.entries()) {
      // fenêtre glissante
      let start = 0;
      for (let end = 0; end < arr.length; end++) {
        while (arr[end].ts - arr[start].ts > thr) start++;

        // collecte uniques
        const window = arr.slice(start, end + 1);
        const uniq = new Map(); // plate -> first seen in window
        for (const w of window) if (!uniq.has(w.plate)) uniq.set(w.plate, w);

        if (uniq.size >= minV) {
          const vehicles = [...uniq.values()].sort((a,b) => a.ts - b.ts);
          groups.push({
            site,
            tMin: vehicles[0].ts,
            tMax: vehicles[vehicles.length - 1].ts,
            vehicles, // array of row
          });
        }
      }
    }
    return groups;
  }

  // ============================================================
  // MODULE SCORING (v1 simple)
  // ============================================================
  function scoreAndMerge(groups, cfg) {
  const minSites = cfg.minSites;
  const strictOrder = cfg.strictOrder;

  const keyFor = (g) => g.vehicles.map(v => v.plate).sort().join("|");
  const merged = new Map();

  for (const g of groups) {
    const key = keyFor(g);
    if (!merged.has(key)) {
      merged.set(key, {
        plates: g.vehicles.map(v => v.plate).sort(),
        sites: new Set(),
        occurrences: []
      });
    }
    const m = merged.get(key);
    m.sites.add(g.site);
    m.occurrences.push(g);
  }

  const out = [];
  for (const m of merged.values()) {
    const sitesCount = m.sites.size;
    if (sitesCount < minSites) continue;

    let rawScore = m.occurrences.length * sitesCount;

    if (strictOrder) {
      const firsts = m.occurrences.map(o => o.vehicles[0]?.plate).filter(Boolean);
      const mode = firsts.sort((a,b)=>
        firsts.filter(x=>x===b).length - firsts.filter(x=>x===a).length
      )[0];
      const stability = firsts.filter(x => x === mode).length / Math.max(1, firsts.length);
      rawScore += Math.round(stability * 5);
    }

    const scorePctRaw = toPercentSaturating(rawScore, 12);

    out.push({
      scorePctRaw,
      rawScore,
      plates: m.plates,
      sitesCount,
      occurrences: m.occurrences
    });
  }

  out.sort((a,b) => b.scorePctRaw - a.scorePctRaw);
  return out;
}

function buildQualificationText({ niveau, plaques, lieux }) {
  const plaquesTxt = (plaques || []).join(", ") || "—";
  const lieuxTxt = (lieux || []).join(", ") || "—";

  if (niveau === "eleve") {
    return `Qualification du phénomène :

Les données analysées mettent en évidence des passages rapprochés et répétés entre les véhicules ${plaquesTxt}, sur les sites ${lieuxTxt}.

Les écarts temporels observés et la répétition des occurrences sont compatibles avec un déplacement coordonné de type convoi.

Ces éléments constituent des indices concordants justifiant des investigations complémentaires (recoupements LAPI, exploitation vidéosurveillance, contrôles associés).`;
  }

  if (niveau === "modere") {
    return `Qualification du phénomène :

Plusieurs passages rapprochés ont été observés entre les véhicules ${plaquesTxt}, sur les sites ${lieuxTxt}.

La répétition partielle des occurrences suggère l’existence possible d’un déplacement coordonné.

Des vérifications complémentaires sont nécessaires afin d’écarter une coïncidence fortuite.`;
  }

  return `Qualification du phénomène :

Des passages rapprochés ont été constatés entre les véhicules ${plaquesTxt}, sur les sites ${lieuxTxt}.

En l’état, les éléments relevés ne permettent pas de caractériser un déplacement coordonné structuré.

Les faits demeurent compatibles avec des coïncidences de circulation.`;
}

function niveauFromScore(scorePctRaw){
  const pct = roundUpTo5(scorePctRaw);
  if (pct <= 30) return "faible";
  if (pct <= 70) return "modere";
  return "eleve";
}

function extractLieuxFromOccurrences(occurrences){
  // On prend les sites uniques, on garde l’ordre d’apparition
  const seen = new Set();
  const out = [];
  for (const o of (occurrences || [])) {
    const s = o?.site;
    if (s && !seen.has(s)) { seen.add(s); out.push(s); }
  }
  return out;
}

function renderRapportForSelection(){
  if (!els.rapportTexte || !els.btnCopierRapport) return;

  const isEnquete = !!els.toggleModeEnquete?.checked;

  // On veut le rapport uniquement en vue synthétique + ligne sélectionnée
  if (isEnquete || state.selectedResultIndex < 0) {
    els.rapportTexte.textContent = "—";
    if (els.rapportHint) els.rapportHint.style.display = "";
    els.btnCopierRapport.disabled = true;
    return;
  }

  const r = state.results[state.selectedResultIndex];
  if (!r) {
    els.rapportTexte.textContent = "—";
    if (els.rapportHint) els.rapportHint.style.display = "";
    els.btnCopierRapport.disabled = true;
    return;
  }

  const niveau = niveauFromScore(r.scorePctRaw);
  const plaques = r.plates || [];
  const lieux = extractLieuxFromOccurrences(r.occurrences);

  const texte = buildQualificationText({ niveau, plaques, lieux });

  els.rapportTexte.textContent = texte;
  if (els.rapportHint) els.rapportHint.style.display = "none";
  els.btnCopierRapport.disabled = false;
}

  // ============================================================
  // MODULE UI
  // ============================================================
  function renderFileList() {
    els.fileList.innerHTML = "";
    for (const f of state.files) {
      const li = document.createElement("li");
      li.textContent = `${f.name} (${Math.round(f.size/1024)} Ko)`;
      els.fileList.appendChild(li);
    }
    els.btnParse.disabled = state.files.length === 0;
  }

  function renderResults(results, cfg) {
  if (!results.length) {
    els.resultsBody.innerHTML = `
      <tr><td colspan="6" class="fr-text--sm fr-hint-text">Aucun convoi détecté avec ces paramètres.</td></tr>
    `;
    return;
  }

  els.resultsBody.innerHTML = results.map((r, idx) => {
    const maxWindowMs = Math.max(...r.occurrences.map(o => o.tMax - o.tMin));
    const maxWindowSec = Math.round(maxWindowMs / 1000);

    // Détails sur UNE ligne (avec tooltip)
    const detailsText = r.occurrences
      .slice(0, 3)
      .map(o => `${o.site} (${new Date(o.tMin).toLocaleString()} → ${new Date(o.tMax).toLocaleTimeString()})`)
      .join(" • ");

    const moreText = r.occurrences.length > 3 ? ` • +${r.occurrences.length - 3} autres` : "";
    const detailsFull = detailsText + moreText;

    const scoreCell = renderScoreBadgeHtml(r.scorePctRaw);

    return `
      <tr data-idx="${idx}" class="gofast-result-row" role="button" tabindex="0" title="Afficher la timeline">
        <td>${scoreCell}</td>
        <td>${escapeHtml(r.plates.join(", "))}</td>
        <td class="col-small">${r.sitesCount}</td>
        <td class="col-small">${maxWindowSec}s</td>
        <td class="col-lieu">${escapeHtml(r.occurrences[0]?.site || "")}</td>
        <td class="col-details" title="${escapeHtml(detailsFull)}">${escapeHtml(detailsFull)}</td>
      </tr>
    `;
  }).join("");

  bindResultRowSelection();
}

  function renderResultsEnquete(rawGroups) {
  if (!rawGroups.length) {
    els.resultsBody.innerHTML = `
  <tr><td colspan="6" class="fr-text--sm fr-hint-text">Aucun convoi détecté avec ces paramètres.</td></tr>
`;
    return;
  }

  els.resultsBody.innerHTML = rawGroups.map((g) => {
    const windowSec = Math.round((g.tMax - g.tMin) / 1000);
    const plates = g.vehicles.map(v => v.plate).join(", ");

    // Colonne Lieu : uniquement le site
    const lieu = g.site;

    // Colonne Détails : horodatage sur une ligne
    const detailsText =
      `${new Date(g.tMin).toLocaleString()} → ${new Date(g.tMax).toLocaleTimeString()}`;

    return `
      <tr>
        <td>—</td>
        <td>${escapeHtml(plates)}</td>
        <td class="col-small">1</td>
        <td class="col-small">${windowSec}s</td>
        <td class="col-lieu">${escapeHtml(lieu)}</td>
        <td class="col-details" title="${escapeHtml(detailsText)}">${escapeHtml(detailsText)}</td>
      </tr>
    `;
  }).join("");
}

function renderCurrent() {
  const isEnquete = !!els.toggleModeEnquete?.checked;

  if (isEnquete) {
    state.hasSeenEnquete = true;
    setStatus("info", "Vue détaillée");
    renderResultsEnquete(state.rawGroups);
  } else {
    // IMPORTANT : afficher "Vue synthétique" uniquement si on a déjà coché une fois
    if (state.hasSeenEnquete) {
      setStatus("info", "Vue synthétique");
    }
    renderResults(state.results, getConfig());
  }
      // rafraîchit la timeline si une sélection existe
    if (state.selectedResultIndex >= 0 || !!els.toggleModeEnquete?.checked) {
      renderTimelineForSelection();
      renderRapportForSelection();
}
}

  function getConfig() {
    return {
      thresholdSeconds: Number(els.thresholdSeconds.value || 90),
      minVehicles: Number(els.minVehicles.value || 3),
      minSites: Number(els.minSites.value || 2),
      strictOrder: !!els.toggleStrictOrder.checked
    };
  }

function resetAll() {
  state.files = [];
  state.rows = [];
  state.groups = [];
  state.rawGroups = [];
  state.results = [];
  state.hasSeenEnquete = false;
  state.selectedResultIndex = -1;

  // UI import / état
  els.toggleModeEnquete.checked = false;
  els.toggleModeEnquete.disabled = true;
  els.fileInput.value = "";
  els.statsText.textContent = "";
  setStatus("info", "En attente d’import");
  renderFileList();

  // Tableau résultats
  els.resultsBody.innerHTML = `
    <tr><td colspan="6" class="fr-text--sm fr-hint-text">Aucun résultat pour le moment.</td></tr>
  `;

  // Timeline
  const hint = document.getElementById("timelineHint");
  if (hint) hint.style.display = "";

  const tlLegend = document.getElementById("timelineLegend");
  if (tlLegend) tlLegend.textContent = "";

  const tlSvg = document.getElementById("timelineSvg");
  if (tlSvg) tlSvg.replaceChildren();

  // Carte "ordre"
  const bar = document.getElementById("orderProgress");
  if (bar) bar.style.width = "0%";

  const orderValue = document.getElementById("orderValue");
  if (orderValue) orderValue.textContent = "—";

  const badge = document.getElementById("orderBadge");
  if (badge) {
    badge.className = "fr-badge fr-badge--info";
    badge.textContent = "—";
  }
  const orderHelp = document.getElementById("orderHelp");
  if (orderHelp) orderHelp.textContent = "Sélectionne une ligne de résultat pour afficher l’indicateur.";

  if (els.rapportHint) els.rapportHint.style.display = "";
  if (els.rapportTexte) els.rapportTexte.textContent = "—";
  if (els.btnCopierRapport) els.btnCopierRapport.disabled = true;
  if (els.copieOk) els.copieOk.style.display = "none";
}

  function bindResultRowSelection() {
  const rows = els.resultsBody.querySelectorAll("tr[data-idx]");
  rows.forEach(tr => {
    const idx = Number(tr.dataset.idx);
    tr.addEventListener("click", () => selectResult(idx));
    tr.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        selectResult(idx);
      }
    });
  });
}

function selectResult(idx) {
  state.selectedResultIndex = idx;

  // feedback visuel simple : surligner la ligne
  els.resultsBody.querySelectorAll("tr[data-idx]").forEach(tr => {
    tr.style.outline = "";
  });
  const active = els.resultsBody.querySelector(`tr[data-idx="${idx}"]`);
  if (active) active.style.outline = "2px solid var(--border-action-high-blue-france)";

  renderTimelineForSelection();

  const hint = document.getElementById("timelineHint");
  if (hint) hint.style.display = "none";

  renderOrderStabilityForSelection();
  renderRapportForSelection();
}

function renderTimelineForSelection() {
  const svg = document.getElementById("timelineSvg");
  const legend = document.getElementById("timelineLegend");
  if (!svg) return;

  svg.replaceChildren();

  const isEnquete = !!els.toggleModeEnquete?.checked;

  let occurrences = [];
  let plates = [];

  if (isEnquete) {
    occurrences = state.rawGroups || [];
    plates = Array.from(new Set(occurrences.flatMap(g => g.vehicles.map(v => v.plate))));
  } else {
    const r = state.results[state.selectedResultIndex];
    if (!r) return;
    occurrences = r.occurrences || [];
    plates = r.plates || [];
  }

  if (!occurrences.length || !plates.length) {
    if (legend) legend.textContent = "";
    return;
  }

  const tMin = Math.min(...occurrences.map(o => o.tMin));
  const tMax = Math.max(...occurrences.map(o => o.tMax));
  const span = Math.max(1, tMax - tMin);

  const W = 1000, H = 320;
  const padL = 160, padR = 20, padT = 20, padB = 30;

  const rows = plates.slice(0, 10);
  const rowGap = (H - padT - padB) / Math.max(1, rows.length);
  const yFor = (i) => padT + rowGap * i + rowGap * 0.5;
  const xForTs = (ts) => padL + (W - padL - padR) * ((ts - tMin) / span);

  svg.appendChild(svgLine(padL, H - padB, W - padR, H - padB, "gofast-tl-axis"));
  [0, 0.25, 0.5, 0.75, 1].forEach(p => {
    const x = padL + (W - padL - padR) * p;
    svg.appendChild(svgLine(x, H - padB, x, padT, "gofast-tl-line"));
  });

  svg.appendChild(svgText(padL, H - 10, new Date(tMin).toLocaleTimeString(), "gofast-tl-label"));
  svg.appendChild(svgText(W - padR - 80, H - 10, new Date(tMax).toLocaleTimeString(), "gofast-tl-label"));

  rows.forEach((plate, i) => {
    const y = yFor(i);

    const gRow = document.createElementNS("http://www.w3.org/2000/svg", "g");
    gRow.setAttribute("class", "gofast-tl-row");
    gRow.dataset.plate = plate;

    gRow.appendChild(svgText(10, y + 4, plate, "gofast-tl-label"));

    occurrences.forEach((o, occIdx) => {
      const veh = o.vehicles.find(v => v.plate === plate);
      if (!veh) return;

      const x = xForTs(veh.ts);
      const dot = svgCircle(x, y, 5, "gofast-tl-dot");
      dot.setAttribute("fill", "var(--background-action-low-blue-france)");

      dot.dataset.plate = plate;
      dot.dataset.site = o.site;
      dot.dataset.time = new Date(veh.ts).toLocaleString();
      dot.dataset.occ = String(occIdx);

      gRow.appendChild(dot);
    });

    svg.appendChild(gRow);
  });

  if (legend) {
    legend.textContent =
      `Fenêtre affichée : ${new Date(tMin).toLocaleString()} → ${new Date(tMax).toLocaleString()} • ${occurrences.length} occurrence(s)`;
  }

  bindTimelineHoverOnly();
}

function svgLine(x1,y1,x2,y2, cls){
  const el = document.createElementNS("http://www.w3.org/2000/svg", "line");
  el.setAttribute("x1", x1); el.setAttribute("y1", y1);
  el.setAttribute("x2", x2); el.setAttribute("y2", y2);
  el.setAttribute("class", cls);
  return el;
}
function svgText(x,y, txt, cls){
  const el = document.createElementNS("http://www.w3.org/2000/svg", "text");
  el.setAttribute("x", x); el.setAttribute("y", y);
  el.setAttribute("class", cls);
  el.textContent = txt;
  return el;
}
function svgCircle(cx,cy,r, cls){
  const el = document.createElementNS("http://www.w3.org/2000/svg", "circle");
  el.setAttribute("cx", cx); el.setAttribute("cy", cy);
  el.setAttribute("r", r);
  el.setAttribute("class", cls);
  return el;
}

function positionTooltipInWrap(e, wrapEl, tipEl, offset = 12, margin = 8) {
  const rect = wrapEl.getBoundingClientRect();

  // coords relatives au wrap
  let x = (e.clientX - rect.left) + offset;
  let y = (e.clientY - rect.top) + offset;

  // on mesure le tooltip (il doit être display:block pour avoir sa taille)
  const tw = tipEl.offsetWidth || 0;
  const th = tipEl.offsetHeight || 0;

  // clamp dans le wrap
  x = Math.max(margin, Math.min(x, rect.width - tw - margin));
  y = Math.max(margin, Math.min(y, rect.height - th - margin));

  tipEl.style.left = `${x}px`;
  tipEl.style.top  = `${y}px`;
}

function bindTimelineHoverOnly() {
  const svg = document.getElementById("timelineSvg");
  const tip = document.getElementById("timelineTooltip");
  if (!svg || !tip) return;

  const dots = svg.querySelectorAll(".gofast-tl-dot");
  const rows = svg.querySelectorAll(".gofast-tl-row");

  function moveTip(e) {
  const wrap = svg.closest(".gofast-timeline-wrap");
  if (!wrap) return;
  positionTooltipInWrap(e, wrap, tip);
}

  function hideTip() {
    tip.style.display = "none";
    rows.forEach(r => r.classList.remove("is-dim"));
    dots.forEach(d => d.classList.remove("is-hover"));
  }

  dots.forEach(dot => {
    dot.addEventListener("mouseenter", (e) => {
      const plate = dot.dataset.plate || "";
      const site  = dot.dataset.site || "";
      const time  = dot.dataset.time || "";

      tip.innerHTML = `<strong>${escapeHtml(plate)}</strong><br>${escapeHtml(site)}<br>${escapeHtml(time)}`;
      tip.style.display = "block";
      moveTip(e);

      rows.forEach(r => r.classList.add("is-dim"));
      const row = svg.querySelector(`.gofast-tl-row[data-plate="${CSS.escape(plate)}"]`);
      if (row) row.classList.remove("is-dim");

      dot.classList.add("is-hover");
    });

    dot.addEventListener("mousemove", moveTip);
    dot.addEventListener("mouseleave", hideTip);
  });

  // si on sort de la zone SVG
  svg.addEventListener("mouseleave", hideTip);
}

function computeOrderStability(occurrences) {
  // Mesure simple et compréhensible :
  // - on regarde le "premier véhicule" (chronologique) de chaque occurrence
  // - stabilité = fréquence du "premier" le plus fréquent
  if (!occurrences || occurrences.length < 2) return 0;

  const firsts = occurrences
    .map(o => (o.vehicles || []).slice().sort((a,b)=>a.ts-b.ts)[0]?.plate)
    .filter(Boolean);

  if (!firsts.length) return 0;

  const counts = new Map();
  firsts.forEach(p => counts.set(p, (counts.get(p) || 0) + 1));
  const max = Math.max(...counts.values());
  return (max / firsts.length) * 100; // 0..100
}

function orderStabilityMeta(pct) {
  // lecture "enquêteur"
  if (pct >= 75) return { label: "Ordre très stable", badge: "success", help:
    "Le même véhicule semble ouvrir (ou fermer) le groupe à la majorité des occurrences : convoi structuré probable." };
  if (pct >= 45) return { label: "Ordre plutôt stable", badge: "info", help:
    "Un véhicule revient souvent en tête : cohérence possible, à recouper avec les sites et les fenêtres." };
  return { label: "Ordre peu stable", badge: "warning", help:
    "L’ordre varie fortement d’une occurrence à l’autre : coïncidence plus probable (ou données incomplètes)." };
}


function renderOrderStabilityForSelection() {
  const bar   = document.getElementById("orderProgress");
  const val   = document.getElementById("orderValue");
  const help  = document.getElementById("orderHelp");
  const badge = document.getElementById("orderBadge");
  if (!bar || !val || !help || !badge) return;

  const isEnquete = !!els.toggleModeEnquete?.checked;

  // On l’affiche surtout en vue synthétique (un groupe sélectionné).
  if (isEnquete || state.selectedResultIndex < 0) {
    bar.style.width = "0%";
    val.textContent = "—";
    badge.className = "fr-badge fr-badge--info";
    badge.textContent = "—";
    help.textContent = "Sélectionne une ligne (vue synthétique) pour afficher l’indicateur.";
    return;
  }

  const r = state.results[state.selectedResultIndex];
  if (!r || !r.occurrences?.length) {
    bar.style.width = "0%";
    val.textContent = "—";
    badge.className = "fr-badge fr-badge--info";
    badge.textContent = "—";
    help.textContent = "Aucune occurrence exploitable pour calculer la stabilité d’ordre.";
    return;
  }

  const pctRaw = computeOrderStability(r.occurrences);
  const pct = Math.round(pctRaw);

  const meta = orderStabilityMeta(pct);

  bar.style.width = `${pct}%`;
  val.textContent = `${pct}%`;
  badge.className = `fr-badge fr-badge--${meta.badge}`;
  badge.textContent = meta.label;
  help.textContent = meta.help;
}

  // ===========================================================
  // ÉVÈNEMENTS
  // ===========================================================
  els.fileInput.addEventListener("change", (e) => {
    const files = [...(e.target.files || [])];
    state.files = files;
    renderFileList();
    setStatus(files.length ? "info" : "info", files.length ? "Fichiers prêts" : "En attente d’import");
  });

  // Drag & drop
  ["dragenter","dragover"].forEach(evt =>
    els.dropzone.addEventListener(evt, (e) => {
      e.preventDefault(); e.stopPropagation();
      els.dropzone.style.borderColor = "var(--border-action-high-blue-france)";
    })
  );
  ["dragleave","drop"].forEach(evt =>
    els.dropzone.addEventListener(evt, (e) => {
      e.preventDefault(); e.stopPropagation();
      els.dropzone.style.borderColor = "var(--border-default-grey)";
    })
  );
  els.dropzone.addEventListener("drop", (e) => {
    const files = [...(e.dataTransfer.files || [])].filter(f => f.name.toLowerCase().endsWith(".csv"));
    if (files.length) {
      state.files = files;
      renderFileList();
      setStatus("info", "Fichiers prêts");
    }
  });

  els.btnReset.addEventListener("click", resetAll);

  els.btnDemo.addEventListener("click", async () => {
    // v1: démo en mémoire (pas de fichier)
    const demo = [
      { plaque:"AA-123-AA", date_heure:"2026-02-12 10:01:10", site:"LAPI A6 - PK12" },
      { plaque:"BB-456-BB", date_heure:"2026-02-12 10:01:40", site:"LAPI A6 - PK12" },
      { plaque:"CC-789-CC", date_heure:"2026-02-12 10:02:05", site:"LAPI A6 - PK12" },

      { plaque:"AA-123-AA", date_heure:"2026-02-12 10:24:10", site:"Péage X" },
      { plaque:"BB-456-BB", date_heure:"2026-02-12 10:24:50", site:"Péage X" },
      { plaque:"CC-789-CC", date_heure:"2026-02-12 10:25:20", site:"Péage X" },
    ];
    state.rows = demo.map(r => normalizeRow(r, "demo")).filter(Boolean);
    setStatus("success", "Démo chargée");
    els.statsText.textContent = `${state.rows.length} passages normalisés`;

    const cfg = getConfig();
    state.rawGroups = detectGroups(state.rows, cfg);
    state.results = scoreAndMerge(state.rawGroups, cfg);
    if (state.results.length > 0) {
      els.toggleModeEnquete.disabled = false;
    } else {
      els.toggleModeEnquete.checked = false;
      els.toggleModeEnquete.disabled = true;
    }
    renderCurrent();
  });

  function decodeCsvFileSmart(file) {
  return file.arrayBuffer().then((buffer) => {
    // 1) UTF-8 strict : si c'est du vrai UTF-8, on le garde
    try {
      return new TextDecoder("utf-8", { fatal: true }).decode(buffer);
    } catch (e) {}

    // helper : tente un encodage, renvoie null si non supporté
    const tryDecode = (enc) => {
      try { return new TextDecoder(enc, { fatal: false }).decode(buffer); }
      catch { return null; }
    };

    // 2) Windows-1252 (souvent)
    const w1252 = tryDecode("windows-1252");

    // Si on voit des "‚" (typique CP850 mal lu), on tente CP850
    if (w1252 && (w1252.includes("‚") || /P‚age/i.test(w1252))) {
      const cp850 = tryDecode("ibm850"); // alias CP850 (Encoding Standard)
      if (cp850) return cp850;
    }

    if (w1252) return w1252;

    // 3) Dernier filet
    const latin1 = tryDecode("iso-8859-1");
    return latin1 ?? "";
  });
}

  els.btnParse.addEventListener("click", async () => {
    if (!state.files.length) return;
    setStatus("info", "Analyse en cours…");
    els.statsText.textContent = "";

    try {
      const allRows = [];
      let ignored = 0;

      for (const f of state.files) {
  // lecture en ANSI (Windows-1252) pour garder les accents (Péage, etc.)
  const txt = await decodeCsvFileSmart(f);

  const parsed = parseCsv(txt);

  for (const r of parsed) {
    const n = normalizeRow(r, f.name);
    if (n) allRows.push(n);
    else ignored++;
  }
}

      state.rows = allRows;
      const cfg = getConfig();
      state.rawGroups = detectGroups(state.rows, cfg);
      state.results = scoreAndMerge(state.rawGroups, cfg);
      if (state.results.length > 0) {
        els.toggleModeEnquete.disabled = false;
      } else {
        els.toggleModeEnquete.checked = false;
        els.toggleModeEnquete.disabled = true;
      }

      setStatus("success", "Analyse terminée");
      els.statsText.textContent = `${state.rows.length} passages normalisés • ${ignored} ignorés • ${state.results.length} groupes`;

      renderCurrent();
    } catch (err) {
      console.error(err);
      setStatus("error", "Erreur d’analyse");
      els.statsText.textContent = String(err?.message || err);
    }
  });

  els.toggleModeEnquete.addEventListener("change", renderCurrent);

  els.btnCopierRapport?.addEventListener("click", async () => {
  const content = els.rapportTexte?.textContent || "";
  if (!content || content === "—") return;

  try {
    await navigator.clipboard.writeText(content);
    if (els.copieOk) {
      els.copieOk.style.display = "block";
      setTimeout(() => (els.copieOk.style.display = "none"), 2200);
    }
  } catch (e) {
    alert("Impossible de copier (droits navigateur).");
  }
});

  // Init
  resetAll();
  </script>
</body>
</html>