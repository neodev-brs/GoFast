<!DOCTYPE html>
<html lang="fr" data-fr-scheme="system">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script>
  (function () {
    try {
      var saved = localStorage.getItem('scheme');
      if (saved) document.documentElement.setAttribute('data-fr-scheme', saved);
    } catch (e) {}
  })();
</script>
  <title>GoFast - Outil de détection des convois de véhicules</title>

  <!-- Favicon (DSFR) -->
  <link rel="icon" type="image/png"
        href="https://www.interieur.gouv.fr/themes/custom/dsfr/src/images/logo/favicon.png">

  <!-- DSFR -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/dsfr/dsfr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/dsfr/utility/utilities.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/utility/icons/icons.min.css">

<!-- STYLE-->
<style>
  /* GoFast – on neutralise le layout "marketing card" DSFR qui pousse le contenu en bas */
  #import .fr-card__body,
  #parametres .fr-card__body,
  #resultats .fr-card__body{
    display: block !important;
  }

  #import .fr-card__content,
  #parametres .fr-card__content,
  #resultats .fr-card__content{
    display: block !important;     /* <= le plus robuste : plus de flex */
    height: auto !important;
  }

  /* Bonus : évite les marges qui donnent l’impression que ça "descend" */
  #import .fr-card__title,
  #parametres .fr-card__title,
  #resultats .fr-card__title{
    margin-top: 0 !important;
  }

/* 1) Si le navigateur utilise le backdrop natif du <dialog> */
#fr-theme-modal::backdrop {
  background: rgba(0, 0, 0, 0.35);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
}

/* 3) On remet le contenu au-dessus */
#fr-theme-modal[open] .fr-modal__body {
  position: relative;
  z-index: 1;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
}

/* Enlève le contour/halo focus DSFR uniquement sur le bouton "Paramètres d’affichage" */
#btnTheme:focus,
#btnTheme:focus-visible {
  outline: none !important;
  box-shadow: none !important;
}

/* Au repos : enlève toute bordure visible si le style tertiary/display en met une */
#btnTheme {
  border: 0 !important;
}

/* Centre verticalement la modale thème */
#fr-theme-modal[open] {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 2rem; /* évite que ça colle aux bords sur petit écran */
}

/* DSFR a parfois un alignement haut via la grille -> on neutralise */
#fr-theme-modal .fr-grid-row{
  margin-top: 0 !important;
}

/* Evite que la modale dépasse en hauteur (petits écrans) */
#fr-theme-modal .fr-modal__body{
  max-height: calc(100vh - 4rem);
  overflow: auto;
}

/* Centrage vertical/hor. SANS casser DSFR (on ne touche pas au <dialog>) */
#fr-theme-modal[open] .fr-container--fluid {
  min-height: 100vh;              /* plein écran */
  display: flex;
  align-items: center;            /* centre vertical */
  justify-content: center;        /* centre horizontal */
}

/* La grille DSFR peut ajouter des marges/alignements, on neutralise */
#fr-theme-modal[open] .fr-grid-row {
  width: 100%;
  margin-top: 0 !important;
  margin-bottom: 0 !important;
}

/* évite que la modale dépasse sur petit écran */
#fr-theme-modal .fr-modal__body {
  max-height: calc(100vh - 4rem);
  overflow: auto;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15); /* tu peux garder */
}

#fr-theme-modal::backdrop {
  background: rgba(0,0,0,.35);
}

/* Supprime définitivement la bordure du bouton Paramètres d'affichage */
#btnTheme.fr-btn--tertiary {
  border: none !important;
}

#btnTheme {
  border: none !important;
  box-shadow: none !important;
}

/* Enlève l'icône DSFR devant le texte dans NOS badges score */
.gofast-bubble::before{
  display: none !important;
  content: none !important;
}

.gofast-score-wrap{
  display:inline-flex;
  flex-direction:column;
  align-items:center;   /* centre le texte */
  gap:.25rem;
}

.gofast-score-level{
  font-size:.75rem;
  opacity:.8;
}

/* Colonnes étroites */
.col-small{
  width:80px;
  white-space:nowrap;
  text-align:center;
}

/* Colonne lieu */
.col-lieu{
  width:180px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* Détails sur une seule ligne */
.col-details{
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* Centre tout le contenu du tableau résultats */
#resultats table th,
#resultats table td{
  text-align: center;
  vertical-align: middle;
}

/* Empêche le retour à la ligne pour la colonne Probabilité */
#resultats table th:first-child,
#resultats table td:first-child{
  white-space: nowrap;
}

/* Empêche le retour à la ligne pour Fenêtre max */
#resultats table th:nth-child(4),
#resultats table td:nth-child(4){
  white-space: nowrap;
}

.gofast-timeline-wrap{
  width: 100%;
  border: 1px solid var(--border-default-grey);
  border-radius: 8px;
  padding: 8px;
  background: var(--background-default-grey);
  overflow: hidden;
}

.gofast-timeline{
  width: 100%;
  height: 320px;
  display: block;
  background: var(--background-default-grey);
}

.gofast-tl-label{
  font: 12px Marianne, Arial, sans-serif;
  fill: var(--text-default-grey);
}

.gofast-tl-axis{
  stroke: var(--border-default-grey);
  stroke-width: 1;
}

.gofast-tl-dot{
  stroke: var(--border-default-grey);
  stroke-width: 1;
}

.gofast-tl-line{
  stroke: var(--border-default-grey);
  stroke-width: 1;
}

.gofast-result-row{ cursor: pointer; }

.gofast-result-row:focus{ outline: 2px solid var(--border-action-high-blue-france); outline-offset: -2px; }

.gofast-timeline-wrap{ position: relative; }

.gofast-tooltip{
  position:absolute;
  z-index: 5;
  display:none;
  pointer-events:none;
  max-width: 360px;
  padding: .5rem .75rem;
  border-radius: .5rem;
  border: 1px solid var(--border-default-grey);
  background: var(--background-default-grey);
  color: var(--text-default-grey);
  box-shadow: 0 8px 24px rgba(0,0,0,.12);
  font: 12px Marianne, Arial, sans-serif;
}

.gofast-tl-dot.is-hover{
  stroke: var(--border-action-high-blue-france);
  stroke-width: 2;
}

.gofast-tl-row.is-dim{ opacity: .25; }

#gaps .fr-card__content{
  display: block !important;
}

</style>

</head>

<body>
  <!-- HEADER DSFR -->
  <header role="banner" class="fr-header">
    <div class="fr-header__body">
      <div class="fr-container">
        <div class="fr-header__body-row">
          <div class="fr-header__brand fr-enlarge-link">
            <div class="fr-header__brand-top">
              <div class="fr-header__logo">
                <p class="fr-logo">
                  Ministère<br>de l’Intérieur
                </p>
              </div>
              <div class="fr-header__navbar">
                <button class="fr-btn--menu fr-btn" data-fr-opened="false" aria-controls="modal-menu" aria-haspopup="menu" title="Menu">
                  Menu
                </button>
              </div>
            </div>

            <div class="fr-header__service">
              <a href="#" title="Accueil">
                <p class="fr-header__service-title">GoFast</p>
              </a>
              <p class="fr-header__service-tagline">Outil de détection des convois de véhicules</p>
            </div>
          </div>

          <div class="fr-header__tools">
            <div class="fr-header__tools-links">
              <ul class="fr-btns-group fr-btns-group--sm">
                <li>
                  <button id="btnDemo" class="fr-btn fr-btn--secondary">Démonstration</button>
                </li>
                <li>
                  <button id="btnReset" class="fr-btn fr-btn--secondary">Réinitialiser</button>
                </li>
                <li>
                  <button id="btnTheme" class="fr-btn fr-btn--tertiary fr-btn--display"
                          aria-controls="fr-theme-modal"
                          data-fr-opened="false"
                          title="Paramètres d'affichage"
                          type="button">
                    Paramètres d’affichage
                  </button>
                </li>
              </ul>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- MENU (optionnel) -->
    <div class="fr-header__menu fr-modal" id="modal-menu" aria-labelledby="modal-menu-title">
      <div class="fr-container">
        <h1 id="modal-menu-title" class="fr-modal__title">Menu principal</h1>
        <button id="modal-menu-primary"
        class="fr-btn--close fr-btn"
        aria-controls="modal-menu"
        title="Fermer">
        <div class="fr-header__menu-links"></div>
        <nav class="fr-nav" role="navigation" aria-label="Menu principal">
          <ul class="fr-nav__list">
            <li class="fr-nav__item"><a class="fr-nav__link" href="#import">Analyse</a></li>
            <li class="fr-nav__item"><a class="fr-nav__link" href="#resultats">Résultats</a></li>
          </ul>
        </nav>
      </div>
    </div>
  </header>

  <main class="fr-container fr-my-4w">

    <!-- GRID -->
    <div class="fr-grid-row fr-grid-row--gutters">

      <!-- IMPORT -->
      <div class="fr-col-12 fr-col-lg-6" id="import">
        <div class="fr-card fr-card--no-arrow">
          <div class="fr-card__body">
            <div class="fr-card__content">
              <h3 class="fr-card__title">Import des fichiers</h3>
              <p class="fr-card__desc">
                Importe un ou plusieurs fichiers CSV (LAPI, péage, exports, etc.).
              </p>

              <div class="fr-upload-group fr-mt-2w">
                <label class="fr-label" for="fileInput">
                  Sélectionner des fichiers CSV
                  <span class="fr-hint-text">Format CSV recommandé (UTF-8). Tu peux en sélectionner plusieurs.</span>
                </label>
                <input class="fr-upload" type="file" id="fileInput" accept=".csv,text/csv" multiple />
              </div>

              <div id="dropzone" class="fr-mt-2w fr-p-2w"
                   style="border: 2px dashed var(--border-default-grey); border-radius: 8px;">
                <strong>Glisse-dépose</strong> tes fichiers ici
                <div class="fr-hint-text fr-mt-1v">Astuce : tu peux aussi déposer des fichiers directement depuis l’explorateur.</div>
              </div>

              <div class="fr-mt-2w">
                <button id="btnParse" class="fr-btn" disabled>Analyser les fichiers</button>
              </div>

              <div class="fr-mt-2w">
                <p class="fr-text--sm fr-mb-1v"><strong>Fichiers chargés :</strong></p>
                <ul id="fileList" class="fr-m-0 fr-pl-2w"></ul>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- PARAMÈTRES -->
      <div class="fr-col-12 fr-col-lg-6" id="parametres">
        <div class="fr-card fr-card--no-arrow">
          <div class="fr-card__body">
            <div class="fr-card__content">
              <h3 class="fr-card__title">Paramètres</h3>
              <p class="fr-card__desc">Ajuste les seuils de détection.</p>

              <div class="fr-input-group">
                <label class="fr-label" for="thresholdSeconds">
                  Seuil temporel (secondes)
                  <span class="fr-hint-text">Intervalle max entre véhicules pour considérer un co-passage.</span>
                </label>
                <input class="fr-input" type="number" id="thresholdSeconds" min="5" max="900" step="5" value="90" />
              </div>

              <div class="fr-input-group">
                <label class="fr-label" for="minVehicles">
                  Nombre minimal de véhicules
                  <span class="fr-hint-text">2 = duo suspect, 3 = ouvreuse/porteuse/suiveuse.</span>
                </label>
                <input class="fr-input" type="number" id="minVehicles" min="2" max="10" step="1" value="3" />
              </div>

              <div class="fr-input-group">
                <label class="fr-label" for="minSites">
                  Nombre minimal de sites (lieux)
                  <span class="fr-hint-text">Répétition sur plusieurs lieux = suspicion renforcée.</span>
                </label>
                <input class="fr-input" type="number" id="minSites" min="1" max="50" step="1" value="2" />
              </div>

              <div class="fr-toggle fr-mt-2w">
                <input type="checkbox" class="fr-toggle__input" id="toggleStrictOrder" checked>
                <label class="fr-toggle__label" for="toggleStrictOrder">
                  Favoriser l’ordre stable (ouvreuse → porteuse → suiveuse)
                </label>
              </div>

              <div class="fr-mt-2w fr-text--sm fr-hint-text">
                Note : GoFast met en évidence des corrélations. Il ne “décide” pas à ta place.
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- RÉSULTATS -->
      <div class="fr-col-12" id="resultats">
        <div class="fr-card fr-enlarge-link fr-card--no-arrow">
          <div class="fr-card__body">
            <div class="fr-card__content">
              <h3 class="fr-card__title">Résultats</h3>
              <p class="fr-card__desc">
                Groupes détectés, triés par pourcentage de probabilité décroissant.
              </p>

              <div class="fr-grid-row fr-grid-row--middle fr-mb-2w">

                <!-- Badge + stats à gauche -->
                <div class="fr-col">
                  <span class="fr-badge fr-badge--info" id="statusBadge">En attente d’import</span>
                  <span class="fr-ml-2w fr-text--sm fr-hint-text" id="statsText"></span>
                </div>

                <!-- Toggle à droite -->
                <div class="fr-col-auto">
                  <div class="fr-toggle fr-toggle--sm fr-m-0">
                    <input type="checkbox" class="fr-toggle__input" id="toggleModeEnquete">
                    <label class="fr-toggle__label" for="toggleModeEnquete">
                      Détails
                    </label>
                  </div>
                </div>

              </div>

              <div class="fr-table fr-table--bordered fr-table--layout-fixed">
                <table>
                    <colgroup>
                      <col style="width:140px">   <!-- % -->
                      <col style="width:220px">   <!-- Véhicules -->
                      <col style="width:70px">    <!-- Sites -->
                      <col style="width:90px">    <!-- Fenêtre max -->
                      <col style="width:160px">   <!-- Lieu -->
                      <col>                       <!-- Détails = prend tout le reste -->
                    </colgroup>
                  <thead>
                    <tr>
                      <th scope="col">Probabilité (en %)</th>
                      <th scope="col">Véhicules</th>
                      <th scope="col">Sites</th>
                      <th scope="col">Fenêtre max</th>
                      <th scope="col">Lieu</th>
                      <th scope="col">Détails</th>
                    </tr>
                  </thead>
                  <tbody id="resultsBody">
                    <tr>
                      <td colspan="5" class="fr-text--sm fr-hint-text">Aucun résultat pour le moment.</td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <p class="fr-text--xs fr-hint-text fr-mt-2w">
                * La portabilité / changement de plaques / incertitudes de saisie peuvent fausser les corrélations. Vérifie toujours avec tes sources.
              </p>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- TIMELINE -->
<div class="fr-col-12" id="timeline">
  <div class="fr-card fr-card--no-arrow">
    <div class="fr-card__body">
      <div class="fr-card__content">
        <div class="fr-grid-row fr-grid-row--middle fr-mb-2w">
          <div class="fr-col">
            <h3 class="fr-card__title">Timeline</h3>
            <p class="fr-card__desc">
              Visualisation temporelle des passages (sélectionne un groupe dans le tableau).
            </p>
          </div>
        </div>

        <div class="fr-alert fr-alert--info fr-mb-2w" id="timelineHint">
          <p>Sélectionne une ligne de résultat pour afficher la timeline.</p>
        </div>

        <div class="gofast-timeline-wrap">
          <svg id="timelineSvg" class="gofast-timeline" viewBox="0 0 1000 320" preserveAspectRatio="none" aria-label="Timeline des passages"></svg>
          <div id="timelineTooltip" class="gofast-tooltip" role="status" aria-live="polite"></div>
        </div>

        <p class="fr-text--xs fr-hint-text fr-mt-2w" id="timelineLegend"></p>
      </div>
    </div>
  </div>
</div>

<!-- COURBE DES ÉCARTS -->
<div class="fr-col-12" id="gaps">
  <div class="fr-card fr-card--no-arrow">
    <div class="fr-card__body">
      <div class="fr-card__content">
        <h3 class="fr-card__title">Courbe des écarts</h3>
        <p class="fr-card__desc">Écarts (en secondes) entre véhicules au sein des occurrences.</p>

        <div class="gofast-timeline-wrap">
          <svg id="gapSvg" class="gofast-timeline" viewBox="0 0 1000 260" preserveAspectRatio="none"></svg>
          <div id="gapTooltip" class="gofast-tooltip" role="status" aria-live="polite"></div>
        </div>

        <p class="fr-text--xs fr-hint-text fr-mt-2w" id="gapLegend"></p>
      </div>
    </div>
  </div>
</div>

  </main>

<dialog id="fr-theme-modal" class="fr-modal" aria-labelledby="fr-theme-modal-title">
  <div class="fr-container fr-container--fluid fr-container-md">
    <div class="fr-grid-row fr-grid-row--center">
      <div class="fr-col-12 fr-col-md-6 fr-col-lg-4">
        <div class="fr-modal__body">
          <div class="fr-modal__header">
            <button aria-controls="fr-theme-modal" title="Fermer" type="button" class="fr-btn--close fr-btn">Fermer</button>
          </div>

          <div class="fr-modal__content">
            <h1 id="fr-theme-modal-title" class="fr-modal__title">Paramètres d’affichage</h1>

            <div id="fr-display" class="fr-display">
              <fieldset class="fr-fieldset" id="display-fieldset">
                <legend class="fr-fieldset__legend--regular fr-fieldset__legend" id="display-fieldset-legend">
                  Choisissez un thème pour personnaliser l’apparence du site.
                </legend>

                <div class="fr-fieldset__element">
                  <div class="fr-radio-group fr-radio-rich">
                    <input value="light" type="radio" id="fr-radios-theme-light" name="fr-radios-theme">
                    <label class="fr-label" for="fr-radios-theme-light">Thème clair</label>
                    <div class="fr-radio-rich__pictogram" aria-hidden="true">
                      <img alt="" width="80" height="80"
                          src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/artwork/pictograms/environment/sun.svg">
                    </div>
                  </div>
                </div>

                <div class="fr-fieldset__element">
                  <div class="fr-radio-group fr-radio-rich">
                    <input value="dark" type="radio" id="fr-radios-theme-dark" name="fr-radios-theme">
                    <label class="fr-label" for="fr-radios-theme-dark">Thème sombre</label>
                    <div class="fr-radio-rich__pictogram" aria-hidden="true">
                      <img alt="" width="80" height="80"
                          src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/artwork/pictograms/environment/moon.svg">
                    </div>
                  </div>
                </div>

                <div class="fr-fieldset__element">
                  <div class="fr-radio-group fr-radio-rich">
                    <input value="system" type="radio" id="fr-radios-theme-system" name="fr-radios-theme">
                    <label class="fr-label" for="fr-radios-theme-system">
                      Système <span class="fr-hint-text">Utilise les paramètres système</span>
                    </label>
                    <div class="fr-radio-rich__pictogram" aria-hidden="true">
                      <img alt="" width="80" height="80"
                          src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/artwork/pictograms/system/system.svg">
                    </div>
                  </div>
                </div>

              </fieldset>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
</dialog>

  <!-- DSFR JS -->
  <script type="module" src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/dsfr/dsfr.module.min.js"></script>
  <script nomodule src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/dsfr/dsfr.nomodule.min.js"></script>

  <script>
(function () {
  const radios = document.querySelectorAll('input[name="fr-radios-theme"]');
  const btn = document.getElementById('btnTheme');
  if (!radios.length) return;

  function getCurrentScheme() {
    try {
      return localStorage.getItem('scheme')
        || document.documentElement.getAttribute('data-fr-scheme')
        || 'system';
    } catch (e) {
      return document.documentElement.getAttribute('data-fr-scheme') || 'system';
    }
  }

  function syncRadios() {
    const scheme = getCurrentScheme();
    radios.forEach(r => r.checked = (r.value === scheme));
  }

  syncRadios();
  if (btn) btn.addEventListener('click', syncRadios);
})();
</script>

  <script>
  "use strict";

  // ============================================================
  // CONFIG / ÉTAT
  // ============================================================
  const state = {
    files: [],
    rows: [],       // lignes normalisées (toutes sources confondues)
    groups: [],      // groupes de convoi détectés
    rawGroups: [],
    results: [],
    hasSeenEnquete: false,
    selectedResultIndex: -1,
  };

  const els = {
    fileInput: document.getElementById("fileInput"),
    dropzone: document.getElementById("dropzone"),
    fileList: document.getElementById("fileList"),
    btnParse: document.getElementById("btnParse"),
    btnReset: document.getElementById("btnReset"),
    btnDemo: document.getElementById("btnDemo"),
    thresholdSeconds: document.getElementById("thresholdSeconds"),
    minVehicles: document.getElementById("minVehicles"),
    minSites: document.getElementById("minSites"),
    toggleStrictOrder: document.getElementById("toggleStrictOrder"),
    resultsBody: document.getElementById("resultsBody"),
    statusBadge: document.getElementById("statusBadge"),
    statsText: document.getElementById("statsText"),
    toggleModeEnquete: document.getElementById("toggleModeEnquete"),
  };

  function setStatus(type, text) {
    // type: info | success | warning | error
    const map = {
      info: "fr-badge--info",
      success: "fr-badge--success",
      warning: "fr-badge--warning",
      error: "fr-badge--error"
    };
    els.statusBadge.className = "fr-badge " + (map[type] || map.info);
    els.statusBadge.textContent = text;
  }

  // ============================================================
  // UTILITAIRES
  // ============================================================
  function normalizePlate(plate) {
    if (!plate) return "";
    return String(plate).toUpperCase().replace(/[^A-Z0-9]/g, "");
  }

  function safeTrim(s) {
    return (s ?? "").toString().trim();
  }

  function normalizeHeaderName(h) {
  // Nettoie : casse, espaces, accents, caractères
  return safeTrim(h)
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")  // enlève accents
    .replace(/[^\w]+/g, "_");                          // remplace tout le reste par _
}

  function parseDateToMs(input) {
    // v1: essaie ISO ou formats classiques. Ajustera selon tes exports.
    const s = safeTrim(input);
    if (!s) return NaN;

    // ISO direct
    const t = Date.parse(s);
    if (!Number.isNaN(t)) return t;

    // Format FR dd/mm/yyyy hh:mm:ss
    const m = s.match(/^(\d{2})[\/\-](\d{2})[\/\-](\d{4})(?:\s+(\d{2}):(\d{2})(?::(\d{2}))?)?$/);
    if (m) {
      const dd = +m[1], mm = +m[2] - 1, yyyy = +m[3];
      const HH = +(m[4] || 0), MM = +(m[5] || 0), SS = +(m[6] || 0);
      return new Date(yyyy, mm, dd, HH, MM, SS).getTime();
    }
    return NaN;
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[c]));
  }

  function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

function roundUpTo5(n) {
  if (!Number.isFinite(n)) return 0;
  n = clamp(n, 0, 100);
  return Math.min(100, Math.ceil(n / 5) * 5);
}

function scoreMeta(percentRaw) {
  const percent = roundUpTo5(percentRaw);

  let color, level;
  if (percent <= 30) {
    color = "success";
    level = "Corrélation faible";
  } else if (percent <= 70) {
    color = "warning";
    level = "Corrélation modérée";
  } else {
    color = "error";
    level = "Corrélation forte";
  }

  return { percent, color, level };
}

function toPercentSaturating(raw, k) {
  // raw >= 0 ; k règle la “vitesse” à laquelle on monte
  // percent = 100 * raw / (raw + k)  => jamais > 100
  raw = Math.max(0, Number(raw) || 0);
  k = Math.max(1, Number(k) || 10);
  return (100 * raw) / (raw + k);
}

function renderScoreBadgeHtml(percentRaw) {
  const { percent, color, level } = scoreMeta(percentRaw);
  return `
    <span class="gofast-score-wrap">
      <span class="fr-badge fr-badge--${color} gofast-bubble" title="${escapeHtml(level)}">${percent}%</span>
      <span class="gofast-score-level">${escapeHtml(level)}</span>
    </span>
  `;
}

  function normalizeRow(raw, sourceName) {
  const keys = Object.keys(raw);

  const get = (...candidates) => {
    for (const c of candidates) {
      const k = keys.find(k => k.includes(c));
      if (k) return raw[k];
    }
    return "";
  };

  const plate = normalizePlate(get("plaque","immat","immatric","immatriculation","plate"));

  // Date/heure : soit "date_heure", soit (date + heure)
  let dateStr =
    get("date_heure","datetime","dateheure","horodatage","timestamp");

  const d = safeTrim(get("date"));
  const h = safeTrim(get("heure","time"));
  if (!safeTrim(dateStr) && d) {
    dateStr = h ? `${d} ${h}` : d;
  }

  const site = safeTrim(get(
  "lieu","site","point","poste","peage","lapi","camera",
  "localisation","adresse"
));

  const ts = parseDateToMs(dateStr);

  if (!plate || Number.isNaN(ts) || !site) return null;

  return { plate, ts, site, source: sourceName || "import", raw };
}

// ============================================================
// MODULE PARSER
// ============================================================
function stripBom(s) {
  return s && s.charCodeAt(0) === 0xFEFF ? s.slice(1) : s;
}

function detectDelimiter(headerLine) {
  const line = headerLine || "";
  const semi = (line.match(/;/g) || []).length;
  const comma = (line.match(/,/g) || []).length;
  return semi >= comma ? ";" : ",";
}

function splitCsvLine(line, delim) {
  const out = [];
  let cur = "";
  let inQ = false;

  for (let i = 0; i < line.length; i++) {
    const ch = line[i];

    if (ch === '"') {
      // double quote escaped
      if (inQ && line[i + 1] === '"') {
        cur += '"';
        i++;
      } else {
        inQ = !inQ;
      }
      continue;
    }

    if (ch === delim && !inQ) {
      out.push(cur);
      cur = "";
      continue;
    }

    cur += ch;
  }

  out.push(cur);
  return out.map(v => safeTrim(v));
}

function parseCsv(text) {
  const raw = stripBom(String(text || "")).replace(/\r/g, "");
  const lines = raw.split("\n").filter(l => l.trim().length);
  if (lines.length < 2) return [];

  const delim = detectDelimiter(lines[0]);

  const headers = splitCsvLine(lines[0], delim)
    .map(h => normalizeHeaderName(h));

  const rows = [];
  for (let i = 1; i < lines.length; i++) {
    const cols = splitCsvLine(lines[i], delim);
    const obj = {};
    for (let c = 0; c < headers.length; c++) {
      obj[headers[c]] = cols[c] ?? "";
    }
    rows.push(obj);
  }
  return rows;
}

  // ============================================================
  // MODULE ENGINE (détection v1)
  // ============================================================
  function detectGroups(rows, cfg) {
    // rows: [{plate, ts, site, ...}]
    // cfg: {thresholdSeconds, minVehicles}
    const thr = cfg.thresholdSeconds * 1000;
    const minV = cfg.minVehicles;

    // index par site
    const bySite = new Map();
    for (const r of rows) {
      if (!bySite.has(r.site)) bySite.set(r.site, []);
      bySite.get(r.site).push(r);
    }
    // tri par temps
    for (const [site, arr] of bySite.entries()) {
      arr.sort((a,b) => a.ts - b.ts);
    }

    const groups = [];
    for (const [site, arr] of bySite.entries()) {
      // fenêtre glissante
      let start = 0;
      for (let end = 0; end < arr.length; end++) {
        while (arr[end].ts - arr[start].ts > thr) start++;

        // collecte uniques
        const window = arr.slice(start, end + 1);
        const uniq = new Map(); // plate -> first seen in window
        for (const w of window) if (!uniq.has(w.plate)) uniq.set(w.plate, w);

        if (uniq.size >= minV) {
          const vehicles = [...uniq.values()].sort((a,b) => a.ts - b.ts);
          groups.push({
            site,
            tMin: vehicles[0].ts,
            tMax: vehicles[vehicles.length - 1].ts,
            vehicles, // array of row
          });
        }
      }
    }
    return groups;
  }

  // ============================================================
  // MODULE SCORING (v1 simple)
  // ============================================================
  function scoreAndMerge(groups, cfg) {
  const minSites = cfg.minSites;
  const strictOrder = cfg.strictOrder;

  const keyFor = (g) => g.vehicles.map(v => v.plate).sort().join("|");
  const merged = new Map();

  for (const g of groups) {
    const key = keyFor(g);
    if (!merged.has(key)) {
      merged.set(key, {
        plates: g.vehicles.map(v => v.plate).sort(),
        sites: new Set(),
        occurrences: []
      });
    }
    const m = merged.get(key);
    m.sites.add(g.site);
    m.occurrences.push(g);
  }

  const out = [];
  for (const m of merged.values()) {
    const sitesCount = m.sites.size;
    if (sitesCount < minSites) continue;

    let rawScore = m.occurrences.length * sitesCount;

    if (strictOrder) {
      const firsts = m.occurrences.map(o => o.vehicles[0]?.plate).filter(Boolean);
      const mode = firsts.sort((a,b)=>
        firsts.filter(x=>x===b).length - firsts.filter(x=>x===a).length
      )[0];
      const stability = firsts.filter(x => x === mode).length / Math.max(1, firsts.length);
      rawScore += Math.round(stability * 5);
    }

    const scorePctRaw = toPercentSaturating(rawScore, 12);

    out.push({
      scorePctRaw,
      rawScore,
      plates: m.plates,
      sitesCount,
      occurrences: m.occurrences
    });
  }

  out.sort((a,b) => b.scorePctRaw - a.scorePctRaw);
  return out;
}

  // ============================================================
  // MODULE UI
  // ============================================================
  function renderFileList() {
    els.fileList.innerHTML = "";
    for (const f of state.files) {
      const li = document.createElement("li");
      li.textContent = `${f.name} (${Math.round(f.size/1024)} Ko)`;
      els.fileList.appendChild(li);
    }
    els.btnParse.disabled = state.files.length === 0;
  }

  function renderResults(results, cfg) {
  if (!results.length) {
    els.resultsBody.innerHTML = `
      <tr><td colspan="6" class="fr-text--sm fr-hint-text">Aucun convoi détecté avec ces paramètres.</td></tr>
    `;
    return;
  }

  els.resultsBody.innerHTML = results.map((r, idx) => {
    const maxWindowMs = Math.max(...r.occurrences.map(o => o.tMax - o.tMin));
    const maxWindowSec = Math.round(maxWindowMs / 1000);

    // Détails sur UNE ligne (avec tooltip)
    const detailsText = r.occurrences
      .slice(0, 3)
      .map(o => `${o.site} (${new Date(o.tMin).toLocaleString()} → ${new Date(o.tMax).toLocaleTimeString()})`)
      .join(" • ");

    const moreText = r.occurrences.length > 3 ? ` • +${r.occurrences.length - 3} autres` : "";
    const detailsFull = detailsText + moreText;

    const scoreCell = renderScoreBadgeHtml(r.scorePctRaw);

    return `
      <tr data-idx="${idx}" class="gofast-result-row" role="button" tabindex="0" title="Afficher la timeline">
        <td>${scoreCell}</td>
        <td>${escapeHtml(r.plates.join(", "))}</td>
        <td class="col-small">${r.sitesCount}</td>
        <td class="col-small">${maxWindowSec}s</td>
        <td class="col-lieu">${escapeHtml(r.occurrences[0]?.site || "")}</td>
        <td class="col-details" title="${escapeHtml(detailsFull)}">${escapeHtml(detailsFull)}</td>
      </tr>
    `;
  }).join("");

  bindResultRowSelection();
}

  function renderResultsEnquete(rawGroups) {
  if (!rawGroups.length) {
    els.resultsBody.innerHTML = `
  <tr><td colspan="6" class="fr-text--sm fr-hint-text">Aucun convoi détecté avec ces paramètres.</td></tr>
`;
    return;
  }

  els.resultsBody.innerHTML = rawGroups.map((g) => {
    const windowSec = Math.round((g.tMax - g.tMin) / 1000);
    const plates = g.vehicles.map(v => v.plate).join(", ");

    // Colonne Lieu : uniquement le site
    const lieu = g.site;

    // Colonne Détails : horodatage sur une ligne
    const detailsText =
      `${new Date(g.tMin).toLocaleString()} → ${new Date(g.tMax).toLocaleTimeString()}`;

    return `
      <tr>
        <td>—</td>
        <td>${escapeHtml(plates)}</td>
        <td class="col-small">1</td>
        <td class="col-small">${windowSec}s</td>
        <td class="col-lieu">${escapeHtml(lieu)}</td>
        <td class="col-details" title="${escapeHtml(detailsText)}">${escapeHtml(detailsText)}</td>
      </tr>
    `;
  }).join("");
}

function renderCurrent() {
  const isEnquete = !!els.toggleModeEnquete?.checked;

  if (isEnquete) {
    state.hasSeenEnquete = true;
    setStatus("info", "Vue détaillée");
    renderResultsEnquete(state.rawGroups);
  } else {
    // IMPORTANT : afficher "Vue synthétique" uniquement si on a déjà coché une fois
    if (state.hasSeenEnquete) {
      setStatus("info", "Vue synthétique");
    }
    renderResults(state.results, getConfig());
  }
      // rafraîchit la timeline si une sélection existe
    if (state.selectedResultIndex >= 0 || !!els.toggleModeEnquete?.checked) {
      renderTimelineForSelection();
      renderGapCurveForSelection();
}
}

  function getConfig() {
    return {
      thresholdSeconds: Number(els.thresholdSeconds.value || 90),
      minVehicles: Number(els.minVehicles.value || 3),
      minSites: Number(els.minSites.value || 2),
      strictOrder: !!els.toggleStrictOrder.checked
    };
  }

  function resetAll() {
    state.files = [];
    state.rows = [];
    state.groups = [];
    state.hasSeenEnquete = false;
    els.toggleModeEnquete.checked = false;
    els.toggleModeEnquete.disabled = true;
    els.fileInput.value = "";
    renderFileList();
    els.statsText.textContent = "";
    setStatus("info", "En attente d’import");
    els.resultsBody.innerHTML = `<tr><td colspan="5" class="fr-text--sm fr-hint-text">Aucun résultat pour le moment.</td></tr>`;
    state.selectedResultIndex = -1;
    document.getElementById("timelineHint")?.style && (document.getElementById("timelineHint").style.display = "");
    document.getElementById("timelineLegend").textContent = "";
    document.getElementById("gapLegend").textContent = "";
    document.getElementById("timelineSvg")?.replaceChildren();
    document.getElementById("gapSvg")?.replaceChildren();
  }

  function bindResultRowSelection() {
  const rows = els.resultsBody.querySelectorAll("tr[data-idx]");
  rows.forEach(tr => {
    const idx = Number(tr.dataset.idx);
    tr.addEventListener("click", () => selectResult(idx));
    tr.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        selectResult(idx);
      }
    });
  });
}

function selectResult(idx) {
  state.selectedResultIndex = idx;

  // feedback visuel simple : surligner la ligne
  els.resultsBody.querySelectorAll("tr[data-idx]").forEach(tr => {
    tr.style.outline = "";
  });
  const active = els.resultsBody.querySelector(`tr[data-idx="${idx}"]`);
  if (active) active.style.outline = "2px solid var(--border-action-high-blue-france)";

  renderTimelineForSelection();

  const hint = document.getElementById("timelineHint");
  if (hint) hint.style.display = "none";

  renderGapCurveForSelection();
}

function renderTimelineForSelection() {
  const svg = document.getElementById("timelineSvg");
  const legend = document.getElementById("timelineLegend");
  if (!svg) return;

  svg.replaceChildren();

  const isEnquete = !!els.toggleModeEnquete?.checked;

  let occurrences = [];
  let plates = [];

  if (isEnquete) {
    occurrences = state.rawGroups || [];
    plates = Array.from(new Set(occurrences.flatMap(g => g.vehicles.map(v => v.plate))));
  } else {
    const r = state.results[state.selectedResultIndex];
    if (!r) return;
    occurrences = r.occurrences || [];
    plates = r.plates || [];
  }

  if (!occurrences.length || !plates.length) {
    if (legend) legend.textContent = "";
    return;
  }

  const tMin = Math.min(...occurrences.map(o => o.tMin));
  const tMax = Math.max(...occurrences.map(o => o.tMax));
  const span = Math.max(1, tMax - tMin);

  const W = 1000, H = 320;
  const padL = 160, padR = 20, padT = 20, padB = 30;

  const rows = plates.slice(0, 10);
  const rowGap = (H - padT - padB) / Math.max(1, rows.length);
  const yFor = (i) => padT + rowGap * i + rowGap * 0.5;
  const xForTs = (ts) => padL + (W - padL - padR) * ((ts - tMin) / span);

  svg.appendChild(svgLine(padL, H - padB, W - padR, H - padB, "gofast-tl-axis"));
  [0, 0.25, 0.5, 0.75, 1].forEach(p => {
    const x = padL + (W - padL - padR) * p;
    svg.appendChild(svgLine(x, H - padB, x, padT, "gofast-tl-line"));
  });

  svg.appendChild(svgText(padL, H - 10, new Date(tMin).toLocaleTimeString(), "gofast-tl-label"));
  svg.appendChild(svgText(W - padR - 80, H - 10, new Date(tMax).toLocaleTimeString(), "gofast-tl-label"));

  rows.forEach((plate, i) => {
    const y = yFor(i);

    const gRow = document.createElementNS("http://www.w3.org/2000/svg", "g");
    gRow.setAttribute("class", "gofast-tl-row");
    gRow.dataset.plate = plate;

    gRow.appendChild(svgText(10, y + 4, plate, "gofast-tl-label"));

    occurrences.forEach((o, occIdx) => {
      const veh = o.vehicles.find(v => v.plate === plate);
      if (!veh) return;

      const x = xForTs(veh.ts);
      const dot = svgCircle(x, y, 5, "gofast-tl-dot");
      dot.setAttribute("fill", "var(--background-action-low-blue-france)");

      dot.dataset.plate = plate;
      dot.dataset.site = o.site;
      dot.dataset.time = new Date(veh.ts).toLocaleString();
      dot.dataset.occ = String(occIdx);

      gRow.appendChild(dot);
    });

    svg.appendChild(gRow);
  });

  if (legend) {
    legend.textContent =
      `Fenêtre affichée : ${new Date(tMin).toLocaleString()} → ${new Date(tMax).toLocaleString()} • ${occurrences.length} occurrence(s)`;
  }

  bindTimelineHoverOnly();
}

function svgLine(x1,y1,x2,y2, cls){
  const el = document.createElementNS("http://www.w3.org/2000/svg", "line");
  el.setAttribute("x1", x1); el.setAttribute("y1", y1);
  el.setAttribute("x2", x2); el.setAttribute("y2", y2);
  el.setAttribute("class", cls);
  return el;
}
function svgText(x,y, txt, cls){
  const el = document.createElementNS("http://www.w3.org/2000/svg", "text");
  el.setAttribute("x", x); el.setAttribute("y", y);
  el.setAttribute("class", cls);
  el.textContent = txt;
  return el;
}
function svgCircle(cx,cy,r, cls){
  const el = document.createElementNS("http://www.w3.org/2000/svg", "circle");
  el.setAttribute("cx", cx); el.setAttribute("cy", cy);
  el.setAttribute("r", r);
  el.setAttribute("class", cls);
  return el;
}

function bindTimelineHoverOnly() {
  const svg = document.getElementById("timelineSvg");
  const tip = document.getElementById("timelineTooltip");
  if (!svg || !tip) return;

  const dots = svg.querySelectorAll(".gofast-tl-dot");
  const rows = svg.querySelectorAll(".gofast-tl-row");

  function moveTip(e) {
    const wrap = svg.closest(".gofast-timeline-wrap");
    const rect = wrap.getBoundingClientRect();
    tip.style.left = `${e.clientX - rect.left + 12}px`;
    tip.style.top  = `${e.clientY - rect.top + 12}px`;
  }

  function hideTip() {
    tip.style.display = "none";
    rows.forEach(r => r.classList.remove("is-dim"));
    dots.forEach(d => d.classList.remove("is-hover"));
  }

  dots.forEach(dot => {
    dot.addEventListener("mouseenter", (e) => {
      const plate = dot.dataset.plate || "";
      const site  = dot.dataset.site || "";
      const time  = dot.dataset.time || "";

      tip.innerHTML = `<strong>${escapeHtml(plate)}</strong><br>${escapeHtml(site)}<br>${escapeHtml(time)}`;
      tip.style.display = "block";
      moveTip(e);

      rows.forEach(r => r.classList.add("is-dim"));
      const row = svg.querySelector(`.gofast-tl-row[data-plate="${CSS.escape(plate)}"]`);
      if (row) row.classList.remove("is-dim");

      dot.classList.add("is-hover");
    });

    dot.addEventListener("mousemove", moveTip);
    dot.addEventListener("mouseleave", hideTip);
  });

  // si on sort de la zone SVG
  svg.addEventListener("mouseleave", hideTip);
}

function renderGapCurveForSelection() {
  const svg = document.getElementById("gapSvg");
  const tip = document.getElementById("gapTooltip");
  const legend = document.getElementById("gapLegend");
  if (!svg) return;

  while (svg.firstChild) svg.removeChild(svg.firstChild);
  if (tip) tip.style.display = "none";

  const isEnquete = !!els.toggleModeEnquete?.checked;

  let occurrences = [];
  if (isEnquete) {
    occurrences = state.rawGroups || [];
  } else {
    const r = state.results[state.selectedResultIndex];
    if (!r) return;
    occurrences = r.occurrences || [];
  }

  if (!occurrences.length) return;

  // Pour chaque occurrence : on trie les véhicules par ts, puis on calcule l'écart moyen (sec) entre voisins
  const points = occurrences.map((o, i) => {
    const v = [...o.vehicles].sort((a,b)=>a.ts-b.ts);
    if (v.length < 2) return null;

    const gaps = [];
    for (let k = 1; k < v.length; k++) gaps.push((v[k].ts - v[k-1].ts) / 1000);

    const avg = gaps.reduce((s,x)=>s+x,0) / gaps.length;
    return { i, avg, site: o.site, tMin: o.tMin, tMax: o.tMax };
  }).filter(Boolean);

  if (!points.length) return;

  const W=1000, H=260, padL=60, padR=20, padT=20, padB=30;

  const yMax = Math.max(...points.map(p=>p.avg), 1);
  const yMin = 0;

  const xFor = (i) => padL + (W - padL - padR) * (i / Math.max(1, points.length - 1));
  const yFor = (v) => (H - padB) - (H - padT - padB) * ((v - yMin) / (yMax - yMin || 1));

  // axes
  svg.appendChild(svgLine(padL, padT, padL, H-padB, "gofast-tl-axis"));
  svg.appendChild(svgLine(padL, H-padB, W-padR, H-padB, "gofast-tl-axis"));

  // polyline
  const poly = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
  poly.setAttribute("fill", "none");
  poly.setAttribute("stroke", "var(--border-action-high-blue-france)");
  poly.setAttribute("stroke-width", "2");
  poly.setAttribute("points", points.map(p => `${xFor(p.i)},${yFor(p.avg)}`).join(" "));
  svg.appendChild(poly);

  // points + tooltip
  points.forEach(p => {
    const cx = xFor(p.i);
    const cy = yFor(p.avg);
    const c = svgCircle(cx, cy, 5, "gofast-tl-dot");
    c.setAttribute("fill", "var(--background-action-low-blue-france)");
    c.dataset.txt = `Écart moyen: ${Math.round(p.avg)}s • ${p.site} • ${new Date(p.tMin).toLocaleTimeString()}→${new Date(p.tMax).toLocaleTimeString()}`;
    svg.appendChild(c);

    c.addEventListener("mouseenter", (e) => {
      if (!tip) return;
      tip.textContent = c.dataset.txt;
      tip.style.display = "block";
      const wrap = svg.closest(".gofast-timeline-wrap");
      const rect = wrap.getBoundingClientRect();
      tip.style.left = `${e.clientX - rect.left + 12}px`;
      tip.style.top  = `${e.clientY - rect.top + 12}px`;
      c.classList.add("is-hover");
    });
    c.addEventListener("mousemove", (e) => {
      if (!tip) return;
      const wrap = svg.closest(".gofast-timeline-wrap");
      const rect = wrap.getBoundingClientRect();
      tip.style.left = `${e.clientX - rect.left + 12}px`;
      tip.style.top  = `${e.clientY - rect.top + 12}px`;
    });
    c.addEventListener("mouseleave", () => {
      if (!tip) return;
      tip.style.display = "none";
      c.classList.remove("is-hover");
    });
  });

  if (legend) {
    legend.textContent = `Nombre de points: ${points.length} • Écart max observé: ${Math.round(yMax)}s`;
  }
}

  // ============================================================
  // ÉVÈNEMENTS
  // ============================================================
  els.fileInput.addEventListener("change", (e) => {
    const files = [...(e.target.files || [])];
    state.files = files;
    renderFileList();
    setStatus(files.length ? "info" : "info", files.length ? "Fichiers prêts" : "En attente d’import");
  });

  // Drag & drop
  ["dragenter","dragover"].forEach(evt =>
    els.dropzone.addEventListener(evt, (e) => {
      e.preventDefault(); e.stopPropagation();
      els.dropzone.style.borderColor = "var(--border-action-high-blue-france)";
    })
  );
  ["dragleave","drop"].forEach(evt =>
    els.dropzone.addEventListener(evt, (e) => {
      e.preventDefault(); e.stopPropagation();
      els.dropzone.style.borderColor = "var(--border-default-grey)";
    })
  );
  els.dropzone.addEventListener("drop", (e) => {
    const files = [...(e.dataTransfer.files || [])].filter(f => f.name.toLowerCase().endsWith(".csv"));
    if (files.length) {
      state.files = files;
      renderFileList();
      setStatus("info", "Fichiers prêts");
    }
  });

  els.btnReset.addEventListener("click", resetAll);

  els.btnDemo.addEventListener("click", async () => {
    // v1: démo en mémoire (pas de fichier)
    const demo = [
      { plaque:"AA-123-AA", date_heure:"2026-02-12 10:01:10", site:"LAPI A6 - PK12" },
      { plaque:"BB-456-BB", date_heure:"2026-02-12 10:01:40", site:"LAPI A6 - PK12" },
      { plaque:"CC-789-CC", date_heure:"2026-02-12 10:02:05", site:"LAPI A6 - PK12" },

      { plaque:"AA-123-AA", date_heure:"2026-02-12 10:24:10", site:"Péage X" },
      { plaque:"BB-456-BB", date_heure:"2026-02-12 10:24:50", site:"Péage X" },
      { plaque:"CC-789-CC", date_heure:"2026-02-12 10:25:20", site:"Péage X" },
    ];
    state.rows = demo.map(r => normalizeRow(r, "demo")).filter(Boolean);
    setStatus("success", "Démo chargée");
    els.statsText.textContent = `${state.rows.length} passages normalisés`;

    const cfg = getConfig();
    state.rawGroups = detectGroups(state.rows, cfg);
    state.results = scoreAndMerge(state.rawGroups, cfg);
    if (state.results.length > 0) {
      els.toggleModeEnquete.disabled = false;
    } else {
      els.toggleModeEnquete.checked = false;
      els.toggleModeEnquete.disabled = true;
    }
    renderCurrent();
  });

  function decodeCsvFileSmart(file) {
  return file.arrayBuffer().then((buffer) => {
    // 1) Essai UTF-8 (le plus courant sur les exports modernes)
    let txt = new TextDecoder("utf-8", { fatal: false }).decode(buffer);

    // Si présence du caractère de remplacement, c'est souvent un mauvais décodage
    if (txt.includes("�")) {
      try {
        txt = new TextDecoder("windows-1252", { fatal: false }).decode(buffer);
      } catch {
        // dernier filet : latin1 (souvent accepté)
        txt = new TextDecoder("iso-8859-1", { fatal: false }).decode(buffer);
      }
    }

    return txt;
  });
}

  els.btnParse.addEventListener("click", async () => {
    if (!state.files.length) return;
    setStatus("info", "Analyse en cours…");
    els.statsText.textContent = "";

    try {
      const allRows = [];
      let ignored = 0;

      for (const f of state.files) {
  // lecture en ANSI (Windows-1252) pour garder les accents (Péage, etc.)
  const txt = await decodeCsvFileSmart(f);

  const parsed = parseCsv(txt);

  for (const r of parsed) {
    const n = normalizeRow(r, f.name);
    if (n) allRows.push(n);
    else ignored++;
  }
}

      state.rows = allRows;
      const cfg = getConfig();
      state.rawGroups = detectGroups(state.rows, cfg);
      state.results = scoreAndMerge(state.rawGroups, cfg);
      if (state.results.length > 0) {
        els.toggleModeEnquete.disabled = false;
      } else {
        els.toggleModeEnquete.checked = false;
        els.toggleModeEnquete.disabled = true;
      }

      setStatus("success", "Analyse terminée");
      els.statsText.textContent = `${state.rows.length} passages normalisés • ${ignored} ignorés • ${state.results.length} groupes`;

      renderCurrent();
    } catch (err) {
      console.error(err);
      setStatus("error", "Erreur d’analyse");
      els.statsText.textContent = String(err?.message || err);
    }
  });

  els.toggleModeEnquete.addEventListener("change", renderCurrent);

  // Init
  resetAll();
  </script>
</body>
</html>